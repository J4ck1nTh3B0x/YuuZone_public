import{a as fe,c as ve,A as we,r as i,i as ke,Q as l,j as e,S as j,M as je}from"./vendor_react_core-CNRJGlP_.js";import{a as y}from"./vendor_axios-NIGUFBhG.js";import"./vendor_other-Cv4PqGe0.js";import"./vendor_socket_io_client-ClWRkI5z.js";function $e(){var Y;const{t}=fe(),g=ve(),{isAuthenticated:N,user:d,socket:Z}=we(),[b,C]=i.useState("coins"),[L,ee]=i.useState([]),[B,R]=i.useState([]),[F,V]=i.useState(!0),[I,p]=i.useState(!1),[Ne,te]=i.useState(null),[m,ae]=i.useState(null),[E,Q]=i.useState(300),[z,f]=i.useState(!1),[A,S]=i.useState(!1),[h,se]=i.useState(""),[re,ne]=i.useState("all"),[$,ce]=i.useState("price"),[T,oe]=i.useState("asc"),[O,Ce]=i.useState([]),[q,D]=i.useState(!1),[_,G]=i.useState(!1),[Se,H]=i.useState(null),[J,K]=i.useState(!1),{refreshBalance:U,getCoinPackages:v,getAvatars:w}=ke();i.useEffect(()=>{if(N&&(d!=null&&d.id)&&v&&w){const a=setTimeout(()=>{L.length===0&&B.length===0&&k()},2e3);return()=>clearTimeout(a)}},[N,d==null?void 0:d.id,v,w,L.length,B.length]),i.useEffect(()=>{if(!N){g("/login");return}v&&w&&(d!=null&&d.id)&&k()},[N,g,v,w,d==null?void 0:d.id]),i.useEffect(()=>{let a;return z&&E>0&&(a=setInterval(()=>{Q(s=>s<=1?(f(!1),p(!1),l.error(t("coins.paymentExpired")),300):s-1)},1e3)),()=>clearInterval(a)},[z,E,t]),i.useEffect(()=>{let a;return m!=null&&m.payment_reference&&!q&&(H(new Date),W(),a=setInterval(()=>{H(new Date),W()},1e4)),()=>{a&&clearInterval(a)}},[m==null?void 0:m.payment_reference,q]),i.useEffect(()=>{const a=n=>{const{newBalance:c,transactionType:o,amount:x,packageName:P,avatarName:u,isBalanceChange:_e,timestamp:Pe}=n.detail;o==="purchase"&&P?l.success(`${t("coins.paymentCompleted")} - ${P}`):o==="avatar_purchase"&&u&&(l.success(`${t("coins.avatarPurchased")} - ${u}`),R(be=>be.map(M=>M.name===u?{...M,owned:!0,equipped:!1}:M)),k())},s=n=>{const{newBalance:c,oldBalance:o,change:x,timestamp:P}=n.detail;G(!0),setTimeout(()=>G(!1),2e3),Math.abs(x)>50&&(x>0?l.success(`ðŸ’° +${x} coins added! New balance: ${c}`):x<0&&l.info(`ðŸ’° ${Math.abs(x)} coins spent. New balance: ${c}`))},r=async n=>{const{payment_reference:c,payment_type:o,amount:x,tier_name:P}=n.detail;if(o==="coin"){D(!0),l.success(`${t("coins.paymentCompleted")} - ${x} coins added!`),p(!1),f(!1),await U();try{const u=await y.get("/api/user");u.data&&window.dispatchEvent(new CustomEvent("userDataUpdated",{detail:u.data}))}catch{}g(`/payment-success/${c}`)}};return window.addEventListener("coinBalanceUpdated",a),window.addEventListener("coinBalanceChanged",s),window.addEventListener("paymentCompleted",r),()=>{window.removeEventListener("coinBalanceUpdated",a),window.removeEventListener("coinBalanceChanged",s),window.removeEventListener("paymentCompleted",r)}},[t,Z,g]);const k=async(a=!0)=>{try{a&&V(!0);const[s,r]=await Promise.all([v(),w()]);s&&ee(s.packages||s),r&&R(r.avatars||r)}catch(s){console.error("CoinShop: fetchData error",s),a&&l.error(t("coins.fetchError")||"Failed to fetch data")}finally{a&&V(!1)}},ie=async a=>{var s,r;try{const n=await y.post("/api/coins/purchase",{package_id:a});n.data.success&&(te(n.data.payment),ae(n.data.qr_data),p(!0),f(!0),Q(300),D(!1))}catch(n){l.error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.error)||t("coins.purchaseError"))}},le=async a=>{var s,r;try{(await y.post("/api/coins/avatars/purchase",{avatar_id:a})).data.success&&(l.success(t("coins.avatarPurchased")),k(!1))}catch(n){l.error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.error)||t("coins.avatarPurchaseError"))}},W=async(a=null)=>{const s=a||(m==null?void 0:m.payment_reference);if(s&&!A)try{S(!0);const r=await y.get(`/api/subscriptions/payment/status/${s}`);if(r.data.status==="completed"){D(!0),l.success(t("coins.paymentCompleted")),p(!1),f(!1),await U();try{const n=await y.get("/api/user");n.data&&window.dispatchEvent(new CustomEvent("userDataUpdated",{detail:n.data}))}catch{}g(`/payment-success/${s}`)}else r.data.is_expired?(l.error(t("coins.paymentExpired")),p(!1),f(!1)):a&&l.info(t("coins.paymentPending"))}catch{a&&l.error(t("coins.paymentStatusError"))}finally{S(!1)}},de=async a=>{try{S(!0);const s=await y.get(`/api/subscriptions/payment/status/${a}`);s.data.status==="completed"?(l.success(t("coins.paymentCompleted")),await U(),g(`/payment-success/${a}`)):s.data.is_expired?l.error(t("coins.paymentExpired")):l.info(t("coins.paymentPending"))}catch{l.error(t("coins.paymentStatusError"))}finally{S(!1)}},me=a=>{const s=Math.floor(a/60),r=a%60;return`${s}:${r.toString().padStart(2,"0")}`},X=()=>{let a=L;return h&&(a=a.filter(s=>s.name.toLowerCase().includes(h.toLowerCase())||s.coin_amount.toString().includes(h)||s.price_vnd.toString().includes(h))),ue(a)},he=()=>{let a=B;return h&&(a=a.filter(s=>{var r,n,c;return s.name.toLowerCase().includes(h.toLowerCase())||((r=s.description)==null?void 0:r.toLowerCase().includes(h.toLowerCase()))||((n=s.category_name)==null?void 0:n.toLowerCase().includes(h.toLowerCase()))||s.price_coins.toString().includes(h)||((c=s.creator_name)==null?void 0:c.toLowerCase().includes(h.toLowerCase()))})),ge(a)},xe=a=>{se(a.target.value)},pe=a=>{ne(a.target.value),a.target.value==="coins"?C("coins"):a.target.value==="avatars"&&C("avatars")},ue=a=>{const s=[...a];return s.sort((r,n)=>{let c,o;switch($){case"name":c=r.name.toLowerCase(),o=n.name.toLowerCase();break;case"price":c=r.price_vnd,o=n.price_vnd;break;case"coins":c=r.coin_amount,o=n.coin_amount;break;default:c=r.name.toLowerCase(),o=n.name.toLowerCase()}return T==="asc"?c<o?-1:c>o?1:0:c>o?-1:c<o?1:0}),s},ge=a=>{const s=[...a];return s.sort((r,n)=>{let c,o;switch($){case"name":c=r.name.toLowerCase(),o=n.name.toLowerCase();break;case"price":c=r.price_coins,o=n.price_coins;break;case"category":c=(r.category_name||"Uncategorized").toLowerCase(),o=(n.category_name||"Uncategorized").toLowerCase();break;case"creator":c=(r.creator_name||"").toLowerCase(),o=(n.creator_name||"").toLowerCase();break;default:c=r.name.toLowerCase(),o=n.name.toLowerCase()}return T==="asc"?c<o?-1:c>o?1:0:c>o?-1:c<o?1:0}),s},ye=a=>{const[s,r]=a.target.value.split("-");ce(s),oe(r)};return F?e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-theme-blue"})}):e.jsxs("div",{className:"min-h-screen bg-theme-light-gray2 dark:bg-theme-dark-bg pt-20 px-4",children:[e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg shadow-md p-6 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-theme-text-primary dark:text-theme-dark-text",children:t("coins.marketplace")}),e.jsx("p",{className:"text-theme-text-secondary dark:text-theme-dark-text-secondary mt-2",children:t("coins.marketplaceDescription")})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>{K(!0),k(!1).finally(()=>K(!1))},disabled:F||J,className:"px-3 py-1 text-sm bg-theme-blue text-white rounded-md hover:bg-blue-600 transition-colors disabled:opacity-50",children:t(J?"common.loading":"coins.refresh")}),e.jsxs("div",{className:`text-2xl font-bold text-yellow-600 dark:text-yellow-400 flex items-center justify-end gap-2 transition-all duration-300 ${_?"animate-pulse scale-105":""}`,children:[e.jsx(j,{type:"coin",className:`w-8 h-8 ${_?"animate-spin":""}`}),((Y=d==null?void 0:d.wallet)==null?void 0:Y.coin_balance)||0," ",t("coins.coins"),_&&e.jsx("span",{className:"text-sm text-green-500 animate-pulse",children:"ðŸ”„"})]})]}),e.jsx("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:_?t("coins.updatingBalance","Updating..."):t("coins.yourBalance")})]})]})}),O.length>0&&e.jsxs("div",{className:"mb-8 p-4 bg-yellow-100 dark:bg-yellow-900 border border-yellow-400 dark:border-yellow-600 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2",children:t("coins.pendingPayments")}),e.jsx("div",{className:"space-y-2",children:O.map((a,s)=>{var r,n;return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-yellow-700 dark:text-yellow-300",children:[(r=a.notes)==null?void 0:r.replace("Payment reference: ","")," - ",(n=a.amount_vnd)==null?void 0:n.toLocaleString()," VND"]}),e.jsx("button",{onClick:()=>{var c;return de((c=a.notes)==null?void 0:c.replace("Payment reference: ",""))},disabled:A,className:"px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-xs disabled:opacity-50",children:t(A?"coins.checking":"coins.checkStatus")})]},s)})})]}),e.jsx("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg shadow-md p-4 mb-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:t("coins.searchPlaceholder"),className:"w-full pl-10 pr-4 py-2 border border-theme-border-light dark:border-theme-dark-border rounded-lg bg-theme-bg-primary dark:bg-theme-dark-bg text-theme-text-primary dark:text-theme-dark-text",value:h,onChange:xe}),e.jsx(j,{type:"search",className:"absolute left-3 top-2.5 w-5 h-5 text-theme-text-secondary"})]}),e.jsxs("select",{className:"px-4 py-2 border border-theme-border-light dark:border-theme-dark-border rounded-lg bg-theme-bg-primary dark:bg-theme-dark-bg text-theme-text-primary dark:text-theme-dark-text",value:re,onChange:pe,children:[e.jsx("option",{value:"all",children:t("coins.allItems")}),e.jsx("option",{value:"coins",children:t("coins.coinPackages")}),e.jsx("option",{value:"avatars",children:t("coins.avatars")})]}),e.jsx("select",{className:"px-4 py-2 border border-theme-border-light dark:border-theme-dark-border rounded-lg bg-theme-bg-primary dark:bg-theme-dark-bg text-theme-text-primary dark:text-theme-dark-text",value:`${$}-${T}`,onChange:ye,children:b==="coins"?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"price-asc",children:t("coins.sortByPriceAsc")}),e.jsx("option",{value:"price-desc",children:t("coins.sortByPriceDesc")}),e.jsx("option",{value:"coins-asc",children:t("coins.sortByCoinsAsc")}),e.jsx("option",{value:"coins-desc",children:t("coins.sortByCoinsDesc")}),e.jsx("option",{value:"name-asc",children:t("coins.sortByNameAsc")}),e.jsx("option",{value:"name-desc",children:t("coins.sortByNameDesc")})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"price-asc",children:t("coins.sortByPriceAsc")}),e.jsx("option",{value:"price-desc",children:t("coins.sortByPriceDesc")}),e.jsx("option",{value:"category-asc",children:t("coins.sortByCategoryAsc")}),e.jsx("option",{value:"category-desc",children:t("coins.sortByCategoryDesc")}),e.jsx("option",{value:"creator-asc",children:t("coins.sortByCreatorAsc")}),e.jsx("option",{value:"creator-desc",children:t("coins.sortByCreatorDesc")}),e.jsx("option",{value:"name-asc",children:t("coins.sortByNameAsc")}),e.jsx("option",{value:"name-desc",children:t("coins.sortByNameDesc")})]})})]})}),e.jsx("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg shadow-md p-4 mb-6",children:e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("button",{onClick:()=>C("coins"),className:`px-8 py-2 rounded-lg font-medium transition-colors flex items-center justify-center whitespace-normal ${b==="coins"?"bg-theme-blue text-white":"text-theme-text-primary dark:text-theme-dark-text hover:bg-theme-bg-hover"}`,children:[e.jsx(j,{type:"coin",className:"w-5 h-5 mr-2 flex-shrink-0"}),e.jsx("span",{className:"text-center",children:t("coins.coinPackages")})]}),e.jsxs("button",{onClick:()=>C("avatars"),className:`px-6 py-2 rounded-lg font-medium transition-colors flex items-center justify-center whitespace-normal ${b==="avatars"?"bg-theme-blue text-white":"text-theme-text-primary dark:text-theme-dark-text hover:bg-theme-bg-hover"}`,children:[e.jsx("span",{className:"mr-2",children:"ðŸ‘¤"}),e.jsx("span",{className:"text-center",children:t("coins.avatarShop")})]})]})}),e.jsxs("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg shadow-md p-6",children:[b==="coins"&&e.jsx("div",{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6",children:X().length===0?e.jsx("div",{className:"col-span-full text-center py-8",children:e.jsx("p",{className:"text-theme-text-secondary dark:text-theme-dark-text-secondary",children:h?t("coins.noCoinPackagesFound",{searchTerm:h}):t("coins.noCoinPackagesAvailable")})}):X().map(a=>e.jsx("div",{className:"bg-theme-bg-primary dark:bg-theme-dark-bg rounded-lg border border-theme-border-light dark:border-theme-dark-border p-4 hover:shadow-lg transition-shadow",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2",children:e.jsx(j,{type:"coin",className:"w-12 h-12 text-yellow-600 dark:text-yellow-400 mx-auto"})}),e.jsx("h3",{className:"text-lg font-bold text-theme-text-primary dark:text-theme-dark-text mb-2",children:a.name}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400 mb-4",children:[a.coin_amount," ",t("coins.coins")]}),e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary mb-4",children:[a.price_vnd.toLocaleString()," VND"]}),e.jsx("button",{onClick:()=>ie(a.id),className:"w-full bg-theme-blue text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium",children:t("coins.buyNow")})]})},a.id))})}),b==="avatars"&&e.jsx("div",{children:(()=>{const a=he(),s={};return a.forEach(r=>{const n=r.category_name||"Uncategorized";s[n]||(s[n]=[]),s[n].push(r)}),a.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-theme-text-secondary dark:text-theme-dark-text-secondary",children:h?t("coins.noAvatarsFound",{searchTerm:h}):t("coins.noAvatarsAvailable")})}):Object.entries(s).map(([r,n])=>e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-xl font-bold text-theme-text-primary dark:text-theme-dark-text mb-4 border-b border-theme-border-light dark:border-theme-dark-border pb-2",children:r}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:n.map(c=>e.jsx("div",{className:"bg-theme-bg-primary dark:bg-theme-dark-bg rounded-lg border border-theme-border-light dark:border-theme-dark-border p-4 hover:shadow-lg transition-shadow",children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:c.image_url,alt:c.name,className:"w-24 h-24 mx-auto mb-3 rounded-lg object-cover",onError:o=>{o.target.src="https://via.placeholder.com/96x96?text=Avatar"}}),e.jsx("h3",{className:"text-lg font-bold text-theme-text-primary dark:text-theme-dark-text mb-2",children:c.name}),e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsxs("span",{className:"text-yellow-600 dark:text-yellow-400 font-bold text-lg flex items-center gap-1",children:[e.jsx(j,{type:"coin",className:"w-5 h-5"}),c.price_coins]})}),c.owned?e.jsx("div",{className:"text-green-600 dark:text-green-400 font-medium",children:c.equipped?t("coins.equipped"):t("coins.owned")}):c.available_for_purchase?e.jsx("button",{onClick:()=>le(c.id),className:"w-full bg-theme-blue text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium",children:t("coins.buyNow")}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400 font-medium",children:t("coins.unavailable")})]})},c.id))})]},r))})()})]})]}),I&&m&&e.jsx(je,{showModal:I,setShowModal:p,children:e.jsxs("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg p-6 max-w-md mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold text-theme-text-primary dark:text-theme-dark-text mb-4 text-center",children:t("coins.paymentQR")}),e.jsx("div",{className:"text-center mb-4",children:e.jsx("img",{src:m.qr_url,alt:"Payment QR Code",className:"mx-auto border-2 border-theme-border-light dark:border-theme-dark-border rounded-lg"})}),e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("p",{className:"text-lg font-bold text-theme-text-primary dark:text-theme-dark-text",children:m.package_name}),e.jsxs("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:[m.amount.toLocaleString()," VND"]}),e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:[t("coins.paymentReference"),": ",m.payment_reference]})]}),e.jsx("div",{className:"text-center mb-4",children:e.jsxs("div",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:[t("coins.timeRemaining"),": ",me(E)]})}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 text-center",children:["Reference: ",m.payment_reference]}),e.jsx("button",{onClick:()=>p(!1),className:"w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-medium",children:t("common.cancel")})]})]})})]})}export{$e as default};
