import{A as se,a as B,r as o,g as De,d as O,j as e,S as y,b as z,u as et,n as te,E as Re,D as tt,M as st,Q as V,c as rt}from"./vendor_react_core-CNRJGlP_.js";import{a as R}from"./vendor_axios-NIGUFBhG.js";import{u as at}from"./index-DpLneSuz.js";import{P as C}from"./vendor_other-Cv4PqGe0.js";import"./vendor_socket_io_client-ClWRkI5z.js";function nt(r,p){const{socket:a}=se(),{t:j}=B(),[u,c]=o.useState(!1),[x,w]=o.useState(null);o.useEffect(()=>{if(!a)return;const l=()=>{c(!0)},h=()=>{c(!1)},b=M=>{M.room&&M.room.startsWith("chat_")};return c(a.connected),a.on("connect",l),a.on("disconnect",h),a.on("join_success",b),()=>{a.off("connect",l),a.off("disconnect",h),a.off("join_success",b)}},[a]);const f=o.useCallback((l,h)=>{if(!l||!h)return null;const b=[l,h].sort();return`chat_${b[0]}_${b[1]}`},[]);o.useEffect(()=>{if(!a)return;const l=()=>{c(!0)},h=()=>{c(!1)},b=M=>{c(!1)};return a.connected&&c(!0),a.on("connect",l),a.on("disconnect",h),a.on("connect_error",b),()=>{a.off("connect",l),a.off("disconnect",h),a.off("connect_error",b)}},[a,j]),o.useEffect(()=>{if(!a||!r||!p||!u)return;const l=f(r,p);if(l){if(x&&x!==l&&a.emit("leave",{room:x}),x!==l){if(a.emit("join",{room:l}),r){const h=`user_${r}`;a.emit("join",{room:h})}w(l)}return()=>{l&&x===l&&(a.emit("leave",{room:l}),w(null))}}},[a,u,r,p,f,x,j]);const m=o.useCallback(l=>{if(!a)return()=>{};const h=b=>{l(b)};return a.off("new_message",h),a.on("new_message",h),()=>{a.off("new_message",h)}},[a]),i=o.useCallback(l=>{if(!a)return()=>{};const h=b=>{l(b)};return a.on("user_typing",h),()=>{a.off("user_typing",h)}},[a]),g=o.useCallback(l=>{if(!a)return()=>{};const h=b=>{l(b)};return a.on("user_stop_typing",h),()=>{a.off("user_stop_typing",h)}},[a]),A=o.useCallback(l=>{if(!a)return()=>{};const h=b=>{l(b)};return a.on("message_edited",h),()=>{a.off("message_edited",h)}},[a]),W=o.useCallback(l=>{if(!a)return()=>{};const h=b=>{l(b)};return a.on("message_deleted",h),()=>{a.off("message_deleted",h)}},[a]),$=o.useCallback(l=>{!a||!x||a.emit("new_message",{room:x,...l})},[a,x]),q=o.useCallback(()=>{!a||!x||!r||a.emit("typing",{room:x,user:r})},[a,x,r]),Z=o.useCallback(()=>{!a||!x||!r||a.emit("stop_typing",{room:x,user:r})},[a,x,r]);return{connected:u,chatRoom:x,onMessage:m,onTyping:i,onStopTyping:g,onMessageEdit:A,onMessageDelete:W,sendMessage:$,sendTyping:q,sendStopTyping:Z}}function F({size:r="w-6 h-6"}){return e.jsx("div",{className:`animate-spin rounded-full h-6 w-6 border-b-2 border-theme-blue ${r}`})}F.propTypes={size:C.string};function ht(){const{socket:r}=se(),{t:p}=B(),[a,j]=o.useState(null),[u,c]=o.useState(!0),[x,w]=o.useState(null),f=De();o.useEffect(()=>{var g;(g=f.state)!=null&&g.startChatWith&&(j(f.state.startChatWith),window.history.replaceState({},document.title))},[f.state]);const{data:m,isLoading:i}=O({queryKey:["inbox"],queryFn:async()=>await R.get("/api/messages/inbox").then(g=>g.data),staleTime:3*60*1e3,gcTime:8*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1});return o.useEffect(()=>(a?document.title=`${p("navigation.inbox")} | ${a.username}`:document.title=`yuuzone | ${p("navigation.inbox")}`,()=>{document.title="yuuzone"}),[a,p]),o.useEffect(()=>{if(r)return r.on("connect_error",()=>{}),()=>{}},[r]),e.jsxs("div",{className:"fixed top-16 left-0 right-0 bottom-0 flex bg-theme-light-gray2 dark:bg-theme-dark-bg overflow-hidden",children:[e.jsxs("div",{className:`${a?"hidden md:flex":"flex"} flex-col w-full md:w-80 bg-theme-less-white dark:bg-theme-dark-card border-r border-theme-border-light dark:border-theme-dark-border flex-shrink-0 dark:text-theme-dark-text h-full`,children:[e.jsx("div",{className:"flex items-center p-3 md:p-4 border-b border-theme-border-light dark:border-theme-dark-border flex-shrink-0",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{type:"message",className:"w-5 h-5 md:w-6 md:h-6 text-theme-text-secondary"}),e.jsx("h1",{className:"text-base md:text-lg font-semibold text-theme-text-primary dark:text-theme-dark-text truncate",children:p("messages.directMessages")})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto min-h-0",children:i?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx(F,{})}):m&&Array.isArray(m)&&m.length>0?m.slice(0,20).map(g=>e.jsxs("div",{className:`flex items-center p-2 md:p-3 mx-1 md:mx-2 my-1 cursor-pointer rounded-md transition-colors ${(a==null?void 0:a.username)===g.sender.username?"bg-theme-blue-light border border-theme-blue-border":"hover:bg-theme-bg-tertiary dark:hover:bg-theme-dark-bg"}`,onClick:()=>j(g.sender),children:[e.jsx("div",{className:"relative flex-shrink-0",children:e.jsx("img",{src:g.sender.avatar||z,alt:g.sender.username,className:"w-8 h-8 md:w-10 md:h-10 rounded-md object-cover",onError:A=>{A.target.src=z}})}),e.jsxs("div",{className:"flex-1 ml-2 md:ml-3 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-theme-text-primary dark:text-theme-dark-text truncate text-sm md:text-base",children:g.sender.username}),e.jsx("span",{className:"text-xs text-theme-text-secondary dark:text-theme-dark-text-secondary flex-shrink-0 ml-1",children:new Date(g.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),e.jsx("p",{className:"text-xs md:text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary truncate",children:g.content})]}),!g.seen&&!g.latest_from_user&&e.jsx("div",{className:"w-2 h-2 bg-theme-blue rounded-md ml-1 md:ml-2 flex-shrink-0"})]},g.message_id)):e.jsxs("div",{className:"text-center text-theme-text-secondary py-8 px-4 dark:bg-theme-dark-bg dark:text-theme-dark-text",children:[e.jsx(y,{type:"message",className:"w-12 h-12 mx-auto mb-3 text-theme-text-secondary"}),e.jsx("p",{className:"text-sm",children:p("messages.noConversationsYet")}),e.jsx("p",{className:"text-xs text-theme-text-secondary mt-1",children:p("messages.startConversation")})]})})]}),e.jsx("div",{className:"flex flex-col h-full min-h-0 flex-1",children:a&&a.username?e.jsx($e,{sender:a,setCurChat:j,showUserInfo:u,setShowUserInfo:c,editingMessage:x,setEditingMessage:w}):e.jsx("div",{className:"hidden md:flex flex-col items-center justify-center flex-1 h-full bg-theme-light-gray2 dark:bg-theme-dark-bg text-theme-text-secondary dark:text-theme-dark-text",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y,{type:"message",className:"w-20 h-20 mx-auto mb-4 text-theme-text-secondary dark:text-theme-dark-text"}),e.jsx("h2",{className:"text-xl font-semibold text-theme-text-primary dark:text-theme-dark-text mb-2",children:p("messages.yourConversations")}),e.jsx("p",{className:"text-theme-text-secondary dark:text-theme-dark-text",children:p("messages.sendPrivateMessages")})]})})}),a&&u&&e.jsx(ze,{user:a})]})}const $e=({sender:r,setCurChat:p,newChat:a=!1,showUserInfo:j,setShowUserInfo:u,editingMessage:c,setEditingMessage:x})=>{var be,ye,je,ve,ke,we;const w=o.useRef(null),f=et(),{user:m}=se(),{t:i}=B(),g=at(),[A,W]=o.useState(""),[$,q]=o.useState(null),[Z,l]=o.useState(null),[h,b]=o.useState(!1),[M,re]=o.useState(null),[K,H]=o.useState(!1),[ae,ne]=o.useState(!1),[ie,P]=o.useState(null),[Le,J]=o.useState(!1),[oe,Fe]=o.useState(!0),[le,G]=o.useState(0),ce=o.useRef(null),I=o.useRef(null),{connected:T,onMessage:me,onTyping:de,onStopTyping:he,onMessageEdit:xe,onMessageDelete:ue,sendTyping:qe,sendStopTyping:X}=nt(m==null?void 0:m.username,r==null?void 0:r.username)||{},{data:N,isLoading:Pe,error:E}=O({queryKey:["chat",r==null?void 0:r.username],queryFn:async()=>r!=null&&r.username?(await R.get(`/api/messages/chat/${r.username}`)).data:[],enabled:!!(r!=null&&r.username),retry:2,retryDelay:1e3,staleTime:2*60*1e3,gcTime:5*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),{mutate:Qe}=te({mutationFn:async t=>{if(t.file){const s=new FormData;return s.append("content",t.message||""),s.append("receiver",t.sender.username),s.append("file",t.file),await R.post("/api/messages",s,{headers:{"Content-Type":"multipart/form-data"}}).then(n=>n.data)}else return await R.post("/api/messages",{content:t.message,receiver:t.sender.username}).then(s=>s.data)},onMutate:()=>{H(!0)},onSuccess:t=>{W(""),q(null),l(null),H(!1),f.setQueryData(["chat",r==null?void 0:r.username],s=>[...s||[],t]),f.setQueryData(["inbox"],s=>Array.isArray(s)?s.map(n=>n.sender.username===(r==null?void 0:r.username)?{...n,content:t.content,created_at:t.created_at,message_id:t.message_id}:n):[]),setTimeout(()=>{if(I.current){const{scrollTop:s,scrollHeight:n,clientHeight:d}=I.current;s+d>=n-10&&U()}},100)},onError:()=>{H(!1)}}),D=te({mutationFn:async({messageId:t,content:s})=>(await R.put(`/api/messages/${t}/edit`,{content:s})).data,onSuccess:t=>{f.setQueryData(["chat",r==null?void 0:r.username],s=>Array.isArray(s)?s.map(n=>n.message_id===t.message_id?{...n,content:t.content,edited_at:t.edited_at}:n):[])},onError:()=>{V.error(i("messages.editFailed"))}}),Ve=te({mutationFn:async t=>(await R.delete(`/api/messages/${t}/delete`)).data,onSuccess:(t,s)=>{f.setQueryData(["chat",r==null?void 0:r.username],n=>Array.isArray(n)?n.filter(d=>d.message_id!==s):[])},onError:()=>{V.error(i("messages.deleteFailed"))}});if(o.useEffect(()=>{r!=null&&r.username&&R.post("/api/messages/mark-seen",{sender:r.username}).then(()=>{f.setQueryData(["inbox"],t=>Array.isArray(t)?t.map(s=>s.sender.username===r.username&&!s.latest_from_user?{...s,seen:!0}:s):t)}).catch(()=>{})},[r==null?void 0:r.username,f]),o.useEffect(()=>!T||!(r!=null&&r.username)?void 0:me(s=>{var n;((n=s.sender)==null?void 0:n.username)!==(m==null?void 0:m.username)&&(f.setQueryData(["chat",r.username],d=>{if(d==null?void 0:d.some(L=>L.message_id===s.message_id))return d;const k={message_id:s.message_id,content:s.message||s.content||"",media:s.media||null,created_at:s.created_at,sender:s.sender,receiver:s.receiver,seen:!1,seen_at:null},_=[...d||[],k];return setTimeout(()=>{oe?U():(J(!0),G(L=>L+1))},100),_}),f.setQueryData(["inbox"],d=>{var k,_,L;if(!d||!Array.isArray(d))return[{sender:s.sender,receiver:s.receiver,content:s.message,created_at:s.created_at,message_id:s.message_id,latest_from_user:((k=s.sender)==null?void 0:k.username)===(m==null?void 0:m.username),seen:!1}];const v=d.findIndex(S=>{var Ne,_e,Se,Ce,Ae,Me,Te,Ee;return S.sender.username===((Ne=s.sender)==null?void 0:Ne.username)&&((_e=S.receiver)==null?void 0:_e.username)===((Se=s.receiver)==null?void 0:Se.username)||S.sender.username===((Ce=s.receiver)==null?void 0:Ce.username)&&((Ae=S.receiver)==null?void 0:Ae.username)===((Me=s.sender)==null?void 0:Me.username)||S.sender.username===((Te=s.sender)==null?void 0:Te.username)||S.sender.username===((Ee=s.receiver)==null?void 0:Ee.username)});if(v!==-1){const S=[...d];return S[v]={...S[v],content:s.message,created_at:s.created_at,message_id:s.message_id,latest_from_user:((_=s.sender)==null?void 0:_.username)===(m==null?void 0:m.username),seen:!1},S}else return[...d,{sender:s.sender,receiver:s.receiver,content:s.message,created_at:s.created_at,message_id:s.message_id,latest_from_user:((L=s.sender)==null?void 0:L.username)===(m==null?void 0:m.username),seen:!1}]}))}),[T,me,f,r==null?void 0:r.username,m==null?void 0:m.username,oe]),o.useEffect(()=>{if(!T||!(r!=null&&r.username))return;const t=n=>{n.sender===r.username&&(b(!0),setTimeout(()=>b(!1),3e3))},s=n=>{n.sender===r.username&&b(!1)};return de(t),he(s),()=>{}},[T,de,he,r==null?void 0:r.username]),o.useEffect(()=>{if(!T||!(r!=null&&r.username))return;const t=v=>{f.setQueryData(["chat",r.username],k=>Array.isArray(k)?k.map(_=>_.message_id===v.message_id?{..._,content:v.content,edited_at:v.edited_at}:_):k)},s=v=>{f.setQueryData(["chat",r.username],k=>Array.isArray(k)?k.filter(_=>_.message_id!==v.message_id):k)},n=xe(t),d=ue(s);return()=>{n(),d()}},[T,xe,ue,f,r==null?void 0:r.username]),o.useEffect(()=>{var t;(t=w.current)==null||t.scrollIntoView({behavior:"smooth"}),N&&Array.isArray(N)&&f.setQueryData(["chat",r==null?void 0:r.username],s=>Array.isArray(s)?s.filter(n=>n.content&&(n.content.trim()||"").length>0||n.media):[])},[N,f,r==null?void 0:r.username]),!r||!r.username)return e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-gray-500 dark:text-gray-400 mb-4",children:e.jsx("svg",{className:"mx-auto h-12 w-12",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:i("messages.selectChat")}),e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark:text-gray-400",children:i("messages.selectChatDescription")})]})});const Be=t=>{const s=t.target.files[0];if(s){if(s.size>26214400){V.error(i("messages.fileTooLarge"));return}if(q(s),s.type.startsWith("image/")){const n=new FileReader;n.onload=d=>{l(d.target.result)},n.readAsDataURL(s)}else l(null)}},We=()=>{q(null),l(null)},Ze=t=>{x(t)},Ke=async t=>{await g(i("messages.confirmDelete"))&&Ve.mutate(t.message_id)},Ue=async(t,s)=>{if(!s.trim()){V.error(i("messages.emptyMessage"));return}try{await D.mutateAsync({messageId:t,content:s.trim()}),x(null)}catch{}},Ye=t=>{if(W(t.target.value),T&&t.target.value&&t.target.value.length>0){M&&clearTimeout(M),qe();const s=setTimeout(()=>{X()},1e3);re(s)}else T&&(!t.target.value||t.target.value.length===0)&&(M&&(clearTimeout(M),re(null)),X())},fe=t=>{if(t.preventDefault(),!K){if((!A||A.trim().length===0)&&!$){V.error(i("messages.messageValidation"));return}T&&X(),Qe({message:A,sender:r,file:$})}},Oe=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),fe(t))},U=()=>{var t;(t=ce.current)==null||t.scrollIntoView({behavior:"smooth"})},He=()=>{if(!I.current)return;const{scrollTop:t,scrollHeight:s,clientHeight:n}=I.current,d=t+n>=s-10;Fe(d),d&&(J(!1),G(0))},Je=()=>{U(),J(!1),G(0)};function Ge(t){return/(jpg|jpeg|png|webp|avif|gif|svg|image)/.test(t)}function Y(t){return!t||typeof t!="string"?!1:[/^(https?:\/\/)?(www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})(\S*)?$/,/^(https?:\/\/)?youtu\.be\/([a-zA-Z0-9_-]{11})(\S*)?$/,/^(https?:\/\/)?(www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})(\S*)?$/,/^(https?:\/\/)?(www\.)?youtube\.com\/v\/([a-zA-Z0-9_-]{11})(\S*)?$/,/^(https?:\/\/)?m\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})(\S*)?$/,/^(https?:\/\/)?(www\.)?youtube\.com\/gaming\/watch\?v=([a-zA-Z0-9_-]{11})(\S*)?$/].some(n=>n.test(t))}function Q(t){if(!t)return null;const s=t.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);if(s)return s[1];const n=t.match(/[?&]v=([a-zA-Z0-9_-]{11})/);if(n)return n[1];const d=t.match(/embed\/([a-zA-Z0-9_-]{11})/);return d?d[1]:null}function Xe(t){if(!t||!Y(t))return t;const s=Q(t);return s?`https://www.youtube.com/watch?v=${s}`:t}function pe(t){const s=Q(t);return s?`https://img.youtube.com/vi/${s}/maxresdefault.jpg`:null}function ge(t){return!t||typeof t!="string"?!1:Y(t)||/youtube\.com|youtu\.be/i.test(t)||/\.(mp4|webm|ogg|avi|mov|wmv|flv|mkv)(\?.*)?$/i.test(t)?!0:[/vimeo\.com/,/dailymotion\.com/,/facebook\.com.*\/videos/,/twitch\.tv/,/streamable\.com/,/tiktok\.com/,/instagram\.com.*\/reel/,/twitter\.com.*\/video/,/x\.com.*\/video/].some(d=>d.test(t))}const ee=o.useCallback((t,s)=>{if(s)if(ne(!0),t==="video")if(ge(s)){const n=Xe(s);Y(s)?(Q(s),P(e.jsx("div",{className:"relative w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"relative cursor-pointer w-full h-full flex items-center justify-center",onClick:()=>{P(e.jsx("div",{className:"w-full h-full",children:e.jsx(Re,{url:n,width:"100%",height:"100%",controls:!0,playing:!0,style:{borderRadius:"8px"}})}))},children:[e.jsx("img",{src:pe(s),alt:"Video thumbnail",className:"max-w-full max-h-full object-contain rounded-lg",onError:d=>{const v=Q(s);v&&(d.target.src=`https://img.youtube.com/vi/${v}/hqdefault.jpg`)}}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-20 h-20 bg-theme-dark-bg bg-opacity-70 rounded-md flex items-center justify-center",children:e.jsx(y,{type:"play",className:"w-10 h-10 text-theme-dark-text ml-1"})})})]})}))):P(e.jsx("div",{className:"w-full h-full",children:e.jsx(Re,{url:n,width:"100%",height:"100%",controls:!0,playing:!0,style:{borderRadius:"8px"}})}))}else P(e.jsx("div",{className:"flex items-center justify-center w-full h-96 bg-theme-dark-bg text-theme-dark-text rounded-lg",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(y,{type:"video",className:"w-16 h-16 mx-auto mb-4 text-theme-text-muted"}),e.jsx("p",{className:"text-lg mb-2",children:"Invalid Video URL"}),e.jsx("p",{className:"text-sm text-theme-text-muted",children:"The video URL is not supported or invalid"}),e.jsx("p",{className:"text-xs text-theme-text-secondary mt-2 break-all",children:s})]})}));else P(e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("img",{className:"max-w-full max-h-full object-contain rounded-lg shadow-lg",src:s.replace("additional_args","c_auto,g_auto"),alt:"Message image",loading:"lazy"})}))},[]);return o.useEffect(()=>{N&&Array.isArray(N)&&N.length>0&&(I.current||setTimeout(()=>{U()},100))},[r==null?void 0:r.username]),Pe?e.jsx("div",{className:"flex justify-center items-center h-full bg-theme-less-white dark:bg-theme-dark-card",children:e.jsx(F,{size:"w-8 h-8"})}):E?((be=E.response)==null?void 0:be.status)===404&&((je=(ye=E.response)==null?void 0:ye.data)!=null&&je.error)?e.jsxs("div",{className:"flex flex-col justify-center items-center h-full p-4 text-center bg-theme-less-white dark:bg-theme-dark-card",children:[e.jsxs("div",{className:"text-theme-error mb-4",children:[e.jsx(y,{type:"alert",className:"w-12 h-12 mx-auto mb-2"}),e.jsx("h3",{className:"text-lg font-semibold text-theme-text-primary dark:text-theme-dark-text",children:i("messages.cannotChatWithDeletedUser")}),e.jsx("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text mt-1",children:i("messages.userAccountDeleted")})]}),e.jsx("button",{onClick:()=>p(null),className:"px-4 py-2 bg-theme-blue text-white rounded-md hover:bg-theme-blue-dark transition-colors",children:i("common.back")})]}):e.jsxs("div",{className:"flex flex-col justify-center items-center h-full p-4 text-center bg-theme-less-white dark:bg-theme-dark-card",children:[e.jsxs("div",{className:"text-theme-error mb-4",children:[e.jsx(y,{type:"alert",className:"w-12 h-12 mx-auto mb-2"}),e.jsx("h3",{className:"text-lg font-semibold text-theme-text-primary dark:text-theme-dark-text",children:i("messages.errorLoadingChat")}),e.jsx("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text mt-1",children:i("messages.tryRefreshingPage")})]}),e.jsx("button",{onClick:()=>p(null),className:"px-4 py-2 bg-theme-blue text-white rounded-md hover:bg-theme-blue-dark transition-colors",children:i("common.back")})]}):e.jsxs("div",{className:"flex flex-col h-full min-h-0 bg-theme-less-white dark:bg-theme-dark-card flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 md:p-4 border-b border-theme-border-light dark:border-theme-dark-border bg-theme-less-white dark:bg-theme-dark-card shadow-sm flex-shrink-0 min-h-[56px] md:min-h-[64px]",children:[e.jsxs("div",{className:"flex items-center space-x-2 md:space-x-3 min-w-0",children:[e.jsx("button",{onClick:()=>p(null),className:"md:hidden p-1.5 hover:bg-theme-bg-hover dark:hover:bg-theme-dark-bg rounded-md text-theme-text-secondary flex-shrink-0",children:e.jsx(y,{type:"arrow-left",className:"w-4 h-4 md:w-5 md:h-5"})}),e.jsx("div",{className:"flex items-center space-x-1 md:space-x-2 min-w-0",children:e.jsx("h2",{className:"font-semibold text-theme-text-primary dark:text-theme-dark-text text-sm md:text-base truncate",children:r.username})})]}),e.jsx("div",{className:"flex items-center space-x-1 md:space-x-2 flex-shrink-0",children:e.jsx("button",{onClick:()=>u(!j),className:"hidden lg:flex p-1.5 md:p-2 rounded-md text-theme-text-secondary",title:i(j?"messages.hideUserInfo":"messages.showUserInfo"),children:e.jsx(y,{type:"user",className:"w-4 h-4 md:w-5 md:h-5"})})})]}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0 bg-theme-light-gray2 dark:bg-theme-dark-bg dark:text-theme-dark-text relative",children:[e.jsxs("div",{ref:I,onScroll:He,className:"flex-1 overflow-y-auto p-2 md:p-4 space-y-3 md:space-y-4 min-h-0",children:[N&&Array.isArray(N)&&N.length>0?N.map(t=>e.jsxs("div",{className:"flex items-start space-x-2 md:space-x-3 group relative",children:[e.jsx("img",{src:t.sender.avatar||z,alt:t.sender.username,className:"w-8 h-8 md:w-10 md:h-10 rounded-md object-cover flex-shrink-0",onError:s=>{s.target.src=z}}),e.jsxs("div",{className:"flex-1 min-w-0 max-w-full overflow-hidden",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("span",{className:"font-medium text-theme-text-primary dark:text-theme-dark-text text-sm md:text-base",children:t.sender.username}),e.jsx("span",{className:"text-xs text-theme-text-secondary dark:text-theme-dark-text-secondary",children:new Date(t.created_at).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),t.content&&e.jsx("div",{className:"text-theme-text-primary dark:text-theme-dark-text text-sm md:text-base leading-relaxed mb-2",children:e.jsxs("div",{className:"break-words overflow-wrap-anywhere word-break-break-word whitespace-pre-wrap max-w-full",children:[t.content,t.edited_at&&e.jsx("span",{className:"text-xs text-theme-text-secondary ml-2 inline-block",children:"(edited)"})]})}),t.media&&e.jsx("div",{className:"mt-2",children:Ge(t.media)?e.jsx("img",{src:t.media,alt:"Shared image",className:"max-w-xs max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>ee("image",t.media),onLoad:()=>{},onError:s=>{s.target.style.display="none"}}):ge(t.media)?Y(t.media)?e.jsxs("div",{className:"relative max-w-xs max-h-64 rounded-lg cursor-pointer overflow-hidden",onClick:()=>ee("video",t.media),children:[e.jsx("img",{src:pe(t.media),alt:"Video thumbnail",className:"w-full h-full object-cover",onError:s=>{const n=Q(t.media);n&&(s.target.src=`https://img.youtube.com/vi/${n}/hqdefault.jpg`)}}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 hover:bg-opacity-50 transition-all duration-200",children:e.jsx(y,{type:"play",className:"w-12 h-12 text-white"})})]}):e.jsxs("div",{className:"relative max-w-xs max-h-64 rounded-lg cursor-pointer overflow-hidden",onClick:()=>ee("video",t.media),children:[e.jsx("video",{src:t.media,className:"w-full h-full object-cover",preload:"metadata",onLoadedMetadata:()=>{},onError:()=>{}}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 hover:bg-opacity-50 transition-all duration-200",children:e.jsx(y,{type:"play",className:"w-12 h-12 text-white"})})]}):e.jsxs("a",{href:t.media,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center space-x-2 px-3 py-2 bg-theme-blue-light text-theme-blue-dark rounded-lg hover:bg-theme-blue-lighter transition-colors",children:[e.jsx(y,{type:"file",className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"View File"})]})})]}),m&&t.sender.username===m.username&&e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex space-x-1 ml-2",children:[e.jsx("button",{onClick:()=>Ze(t),className:"p-1 text-theme-text-secondary hover:text-theme-blue transition-colors",title:i("messages.editMessage"),children:e.jsx(y,{type:"edit",className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Ke(t),className:"p-1 text-theme-text-secondary hover:text-theme-error hover:bg-theme-error-light rounded transition-colors",title:i("messages.deleteMessage"),children:e.jsx(y,{type:"delete",className:"w-4 h-4"})})]})]},t.message_id)):e.jsx("div",{className:"text-center text-theme-text-secondary py-8 dark:bg-theme-dark-bg dark:text-theme-dark-text",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y,{type:"message",className:"w-16 h-16 mx-auto mb-4 text-theme-text-secondary dark:text-theme-dark-text"}),e.jsx("p",{className:"dark:text-theme-dark-text",children:i(a?"messages.startYourConversation":"messages.noMessages")})]})}),e.jsx("div",{ref:ce})]}),h&&e.jsxs("div",{className:"flex items-start space-x-3 p-2 md:p-4",children:[e.jsx("img",{src:r.avatar||z,alt:r.username,className:"w-10 h-10 rounded-md object-cover flex-shrink-0",onError:t=>{t.target.src=z}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center space-x-2 mb-1",children:e.jsx("span",{className:"font-medium text-theme-text-primary",children:r.username})}),e.jsx("div",{className:"text-theme-text-secondary text-sm italic",children:i("messages.isTyping")})]})]}),e.jsx("div",{ref:w})]}),e.jsx(tt,{children:ae&&ie&&e.jsx(st,{setShowModal:ne,showModal:ae,children:ie})}),Le&&e.jsx("div",{className:"absolute bottom-20 left-1/2 transform -translate-x-1/2 z-10",children:e.jsxs("button",{onClick:Je,className:"bg-theme-blue text-white px-4 py-2 rounded-full shadow-lg hover:bg-theme-blue-dark transition-colors flex items-center space-x-2 text-sm font-medium",children:[e.jsx("span",{children:le>1?`${le} new messages`:"New message"}),e.jsx(y,{type:"down-arrow",className:"w-4 h-4"})]})}),e.jsx("form",{onSubmit:fe,className:"p-3 md:p-4 border-t border-theme-border-light dark:border-theme-dark-border bg-theme-less-white dark:bg-theme-dark-card flex-shrink-0",children:((ve=E==null?void 0:E.response)==null?void 0:ve.status)===404&&((we=(ke=E==null?void 0:E.response)==null?void 0:ke.data)!=null&&we.error)?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"text-theme-error mb-2",children:e.jsx(y,{type:"alert",className:"w-8 h-8 mx-auto mb-2"})}),e.jsx("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:i("messages.cannotChatWithDeletedUser")})]}):e.jsxs(e.Fragment,{children:[$&&e.jsx("div",{className:"mb-3 p-3 bg-theme-light-gray2 dark:bg-theme-dark-bg rounded-lg border border-theme-border-light dark:border-theme-dark-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[Z?e.jsx("img",{src:Z,alt:"Preview",className:"w-12 h-12 object-cover rounded"}):e.jsx("div",{className:"w-12 h-12 bg-theme-bg-tertiary dark:bg-theme-dark-card rounded flex items-center justify-center",children:e.jsx(y,{type:"file",className:"w-6 h-6 text-theme-text-secondary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-theme-text-primary",children:$.name}),e.jsxs("p",{className:"text-xs text-theme-text-secondary",children:[($.size/1024/1024).toFixed(2)," MB"]})]})]}),e.jsx("button",{type:"button",onClick:We,className:"text-theme-error p-1",children:e.jsx(y,{type:"close",className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"flex items-end space-x-2 md:space-x-3",children:[e.jsx("input",{ref:w,type:"text",className:"flex-1 bg-transparent dark:bg-theme-dark-card border-none outline-none px-2 py-2 text-sm md:text-base text-theme-text-primary dark:text-theme-dark-text",placeholder:i("messages.typeMessage"),value:A,onChange:Ye,onKeyDown:Oe,disabled:K}),e.jsxs("label",{className:"w-10 h-10 md:w-12 md:h-12 bg-[rgba(0,0,0,0.01)] text-theme-text-primary rounded-lg cursor-pointer transition-colors flex-shrink-0 flex items-center justify-center",children:[e.jsx(y,{type:"add",className:"w-7 h-7 md:w-9 md:h-9"}),e.jsx("input",{type:"file",onChange:Be,className:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.rar"})]}),e.jsx("button",{type:"submit",disabled:!A.trim()&&!$||K,className:"w-10 h-10 md:w-12 md:h-12 bg-theme-blue text-white rounded-lg hover:bg-theme-blue-dark disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0 flex items-center justify-center",children:K?e.jsx("div",{className:"w-4 h-4 md:w-5 md:h-5 animate-spin",children:e.jsxs("svg",{className:"w-full h-full",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):e.jsx(y,{type:"send",className:"w-4 h-4 md:w-5 md:h-5"})})]})]})}),c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg p-6 w-full max-w-md mx-4 border border-theme-border-light dark:border-theme-dark-border",children:[e.jsx("h3",{className:"text-lg font-medium text-theme-text-primary dark:text-theme-dark-text mb-4",children:i("messages.editMessage")}),e.jsx("textarea",{value:c.content,onChange:t=>x({...c,content:t.target.value}),className:"w-full p-3 border border-theme-border-light dark:border-theme-dark-border rounded-lg resize-none focus:outline-none focus:border-theme-blue bg-theme-less-white dark:bg-theme-dark-bg text-theme-text-primary dark:text-theme-dark-text",rows:4,placeholder:i("messages.editPlaceholder")}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-4",children:[e.jsx("button",{onClick:()=>x(null),className:"px-4 py-2 text-theme-text-secondary hover:text-theme-text-primary transition-colors",children:i("common.cancel")}),e.jsx("button",{onClick:()=>Ue(c.message_id,c.content),disabled:D.isPending,className:"px-4 py-2 bg-theme-blue text-white rounded-lg hover:bg-theme-blue-dark disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:D.isPending?i("common.saving"):i("common.save")})]})]})})]})};$e.propTypes={sender:C.object.isRequired,setCurChat:C.func.isRequired,newChat:C.bool,showUserInfo:C.bool.isRequired,setShowUserInfo:C.func.isRequired,editingMessage:C.object,setEditingMessage:C.func.isRequired};function ze({user:r}){const{t:p}=B(),{data:a,isLoading:j}=O({queryKey:["userProfile",r.username],queryFn:async()=>await R.get(`/api/user/${r.username}`).then(c=>c.data),enabled:!!(r!=null&&r.username)}),u=a||r;return e.jsxs("div",{className:"hidden lg:flex flex-col w-80 bg-theme-less-white dark:bg-theme-dark-card border-l border-theme-border-light dark:border-theme-dark-border flex-shrink-0 h-full overflow-hidden min-w-0 dark:text-theme-dark-text",children:[e.jsx("div",{className:"p-4 xl:p-6 border-b border-theme-border-light dark:border-theme-dark-border flex-shrink-0",children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:u.avatar||z,alt:u.username,className:"w-16 h-16 xl:w-20 xl:h-20 rounded-md object-cover mx-auto mb-3 xl:mb-4",onError:c=>{c.target.src=z}}),e.jsx("h3",{className:"text-lg xl:text-xl font-semibold text-theme-text-primary dark:text-theme-dark-text-secondary mb-1 truncate",children:u.username})]})}),e.jsx("div",{className:"p-3 xl:p-4 flex-1 overflow-y-auto min-h-0",children:e.jsxs("div",{className:"space-y-3 xl:space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs xl:text-sm font-medium text-theme-text-secondary dark:text-theme-dark-text-secondary uppercase tracking-wide mb-2",children:p("messages.aboutMe")}),j?e.jsx("div",{className:"flex justify-center py-2",children:e.jsx(F,{size:"w-4 h-4"})}):e.jsx("p",{className:"text-theme-text-primary dark:text-theme-dark-text-secondary text-xs xl:text-sm leading-relaxed",children:u.bio&&typeof u.bio=="string"?u.bio:p("messages.noBioYet")})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs xl:text-sm font-medium text-theme-text-secondary dark:text-theme-dark-text-secondary uppercase tracking-wide mb-2",children:p("messages.memberSince")}),j?e.jsx("div",{className:"flex justify-center py-2",children:e.jsx(F,{size:"w-4 h-4"})}):e.jsx("p",{className:"text-theme-text-primary dark:text-theme-dark-text-secondary text-xs xl:text-sm",children:u.registrationDate?new Date(u.registrationDate).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):u.registration_date?new Date(u.registration_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):u.created_at?new Date(u.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"Unknown"})]}),e.jsx(Ie,{username:u.username})]})})]})}ze.propTypes={user:C.object.isRequired};function Ie({username:r}){const p=rt(),{t:a}=B(),[j,u]=o.useState(!1),{data:c,isLoading:x}=O({queryKey:["mutualSubthreads",r],queryFn:async()=>await R.get(`/api/mutual-subthreads/${r}`).then(i=>i.data),enabled:!!r});if(x)return e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs xl:text-sm font-medium text-theme-text-secondary dark:text-theme-dark-text-secondary uppercase tracking-wide mb-2",children:a("messages.mutualSubthreads")}),e.jsx("div",{className:"flex justify-center py-2",children:e.jsx(F,{size:"w-4 h-4"})})]});const w=j?c:c==null?void 0:c.slice(0,3),f=c&&Array.isArray(c)&&c.length>3,m=c&&Array.isArray(c)&&c.length>5;return e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs xl:text-sm font-medium text-theme-text-secondary dark:text-theme-dark-text-secondary uppercase tracking-wide mb-2",children:a("messages.mutualSubthreads")}),c&&Array.isArray(c)&&c.length>0?e.jsxs("div",{className:`space-y-2 ${m&&j?"max-h-48 overflow-y-auto":""}`,children:[(w||[]).map(i=>e.jsxs("div",{onClick:()=>p(`/t/${i.name.replace(/^t\//,"")}`),className:"flex items-center space-x-2 p-2 rounded-lg hover:bg-theme-bg-tertiary dark:hover:bg-theme-dark-bg cursor-pointer transition-colors",children:[i.logo?e.jsx("img",{src:i.logo,alt:i.name.replace(/^t\//,""),className:"w-6 h-6 rounded object-cover",onError:g=>{g.target.style.display="none",g.target.nextSibling.style.display="flex"}}):null,e.jsx("div",{className:`w-6 h-6 bg-theme-blue rounded flex items-center justify-center ${i.logo?"hidden":""}`,children:e.jsx("span",{className:"text-white text-xs font-medium",children:i.name.replace(/^t\//,"").charAt(0).toUpperCase()})}),e.jsxs("span",{className:"text-xs text-theme-text-primary dark:text-theme-dark-text-secondary truncate",children:["r/",i.name.replace(/^t\//,"")]})]},i.id)),f&&e.jsx("button",{onClick:()=>u(!j),className:"w-full text-xs font-bold text-theme-blue hover:text-theme-blue-dark transition-colors py-1 px-2 rounded hover:bg-theme-blue-light dark:hover:bg-theme-dark-bg",children:a(j?"messages.showLess":"messages.showMore")})]}):e.jsx("p",{className:"text-xs text-theme-text-secondary dark:text-theme-dark-text-secondary",children:a("messages.noMutualSubthreads")})]})}Ie.propTypes={username:C.string.isRequired};export{$e as Chat,ht as default};
