import{A as Q,u as q,r as m,h as E,g as P,c as D,a as M,f as T,d as U,C as $,j as s,v as I,S as K,b as B,U as R,I as F,D as O,M as z,Q as _}from"./vendor_react_core-CNRJGlP_.js";import{a as w}from"./vendor_axios-NIGUFBhG.js";import{Chat as L}from"./Inbox-CYhrhdSR.js";import"./vendor_other-Cv4PqGe0.js";import"./vendor_socket_io_client-ClWRkI5z.js";import"./index-DpLneSuz.js";function W(){const{socket:o,user:t}=Q(),d=q(),[S,n]=m.useState([]),[b,f]=m.useState(0),k=m.useCallback(a=>{const{type:r,title:c,message:p,action_url:g,sender:u,timestamp:l}=a,x={id:Date.now()+Math.random(),type:r,title:c,message:p,action_url:g,sender:u,timestamp:l||new Date().toISOString(),read:!1};n(i=>[x,...i.slice(0,49)]),f(i=>i+1),Notification.permission==="granted"&&new Notification(c,{body:p,icon:"/favicon.ico",tag:x.id}),d.setQueryData(["notifications"],i=>i?[x,...i.slice(0,49)]:[x])},[d]),h=m.useCallback(a=>{const{username:r,updated_fields:c,avatar_url:p}=a;[["search/user"],["subthreadSubscribers"],["comments"],["posts"]].forEach(u=>{d.setQueryData(u,l=>{if(!l)return l;const x=i=>{var A;return i.username===r||((A=i.user)==null?void 0:A.username)===r?{...i,...c,avatar:p||i.avatar,user:i.user?{...i.user,...c,avatar:p||i.user.avatar}:i.user}:i};return Array.isArray(l)?l.map(x):l.pages?{...l,pages:l.pages.map(i=>Array.isArray(i)?i.map(x):i)}:l})})},[d]),y=m.useCallback(a=>{const{username:r,status:c}=a;d.setQueryData(["userStatus",r],c)},[d]),j=m.useCallback(async()=>"Notification"in window&&Notification.permission==="default"?await Notification.requestPermission()==="granted":Notification.permission==="granted",[]),N=m.useCallback(a=>{n(r=>r.map(c=>c.id===a?{...c,read:!0}:c)),f(r=>Math.max(0,r-1)),d.setQueryData(["notifications"],r=>r&&r.map(c=>c.id===a?{...c,read:!0}:c))},[d]),e=m.useCallback(()=>{n(a=>a.map(r=>({...r,read:!0}))),f(0),d.setQueryData(["notifications"],a=>a&&a.map(r=>({...r,read:!0})))},[d]),v=m.useCallback(()=>{n([]),f(0),d.setQueryData(["notifications"],[])},[d]);m.useEffect(()=>{if(!o||!(t!=null&&t.username))return;const a=setTimeout(()=>{o.emit("join",{room:`user_${t.username}`})},500);return o.on("notification",k),o.on("profile_updated",h),o.on("user_status_changed",y),()=>{clearTimeout(a),o.emit("leave",{room:`user_${t.username}`}),o.off("notification",k),o.off("profile_updated",h),o.off("user_status_changed",y)}},[o,t==null?void 0:t.username,k,h,y]);const C=m.useCallback((a,r,c,p,g=null)=>{o&&o.emit("notification",{recipient_username:a,type:r,title:c,message:p,action_url:g,sender:t==null?void 0:t.username,timestamp:new Date().toISOString()})},[o,t==null?void 0:t.username]);return{notifications:S,unreadCount:b,markAsRead:N,markAllAsRead:e,clearAllNotifications:v,requestNotificationPermission:j,sendNotification:C}}function Z(){const{user:o}=Q(),{username:t}=E(),d=P(),S=D(),{t:n}=M();W();const[b,f]=m.useState(!1),[k,h]=m.useState(!1),[y,j]=m.useState(!1),N=m.useRef(null);T(N,()=>h(!1));const{data:e,isFetching:v}=U({queryKey:["user",t],queryFn:async()=>await w.get(`/api/user/${t}`).then(u=>u.data)}),C=$(d.pathname),{data:a}=U({queryKey:["blockedUsers"],queryFn:async()=>await w.get("/api/user/blocked").then(u=>u.data),enabled:o&&o.username!==t&&!C}),{data:r}=U({queryKey:["isBlockedBy",t],queryFn:async()=>await w.get(`/api/user/blocked-by/${t}`).then(u=>u.data.blocked),enabled:o&&o.username!==t&&!C});m.useEffect(()=>{if(a&&e){const u=a.some(l=>l.username===e.username);j(u)}},[a,e]),m.useEffect(()=>{b==="message"&&f(s.jsx(L,{sender:e,setCurChat:f,newChat:!0}))},[b,e]);const c=()=>{S("/inbox",{state:{startChatWith:e}}),h(!1)},p=async()=>{var u,l;try{await w.post(`/api/user/block/${e.username}`),j(!0),h(!1),_.success(n("alerts.userBlocked",{username:e.username}))}catch(x){_.error(((l=(u=x.response)==null?void 0:u.data)==null?void 0:l.message)||n("alerts.failedToBlockUser"))}},g=async()=>{var u,l;try{await w.post(`/api/user/unblock/${e.username}`),j(!1),h(!1),_.success(n("alerts.userUnblocked",{username:e.username}))}catch(x){_.error(((l=(u=x.response)==null?void 0:u.data)==null?void 0:l.message)||n("alerts.failedToUnblockUser"))}};return m.useEffect(()=>(document.title="u/"+t,()=>document.title="yuuzone"),[t]),s.jsxs("div",{className:"flex flex-col flex-1 items-center w-full bg-theme-light-gray2 dark:bg-theme-dark-bg dark:text-theme-dark-text",children:[v?s.jsx(I,{forPosts:!0}):r?s.jsx("div",{className:"flex flex-col items-center justify-center w-full min-h-96 bg-theme-less-white dark:bg-theme-dark-card rounded-md p-8 m-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("h1",{className:"text-3xl font-bold text-theme-text-primary mb-4",children:n("user.blockedByUser",{username:t})}),s.jsx("p",{className:"text-lg text-theme-text-secondary",children:n("user.blockedByUserDescription")})]})}):s.jsx("div",{className:"flex flex-col items-center w-full bg-theme-light-gray2 dark:bg-theme-dark-bg",children:s.jsxs("div",{className:"flex flex-col p-2 w-full bg-theme-less-white dark:bg-theme-dark-card rounded-md md:p-5 relative",children:[o.username!==(e==null?void 0:e.username)&&!r&&s.jsxs("div",{className:"absolute top-4 right-4 z-10",ref:N,children:[s.jsx("button",{onClick:()=>h(!k),className:"flex items-center justify-center w-8 h-8 text-theme-text-primary",title:"More options",children:s.jsx(K,{type:"more",className:"w-6 h-6"})}),k&&s.jsx("div",{className:"absolute top-full right-0 mt-1 w-40 bg-white dark:bg-theme-dark-card rounded-md shadow-lg border border-gray-200 dark:border-theme-dark-border z-50 dark:text-theme-dark-text",children:s.jsxs("div",{className:"py-1",children:[s.jsx("button",{onClick:c,className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-theme-dark-text hover:bg-gray-100 dark:hover:bg-theme-dark-bg",children:n("user.message")}),s.jsx("button",{onClick:y?g:p,className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-theme-dark-text hover:bg-gray-100 dark:hover:bg-theme-dark-bg",children:n(y?"user.unblock":"user.block")})]})})]}),s.jsxs("div",{className:"flex flex-col flex-1 justify-between items-center p-2 w-full rounded-md md:flex-row md:rounded-md bg-theme-light-gray2 dark:bg-theme-dark-card dark:text-theme-dark-text",children:[s.jsx("img",{src:e.avatar||B,className:"object-cover w-24 h-24 bg-theme-less-white rounded-md cursor-pointer md:w-36 md:h-36",alt:"",onClick:()=>f(s.jsx("img",{src:e.avatar||B,className:"object-cover w-11/12 max-h-5/6 md:w-max md:max-h-screen",alt:""}))}),s.jsxs("div",{className:"flex flex-col flex-1 items-center w-full md:p-2",children:[s.jsxs("h1",{className:"mt-2 text-lg font-semibold md:m-0",children:["u/",e.username]}),s.jsx("div",{className:"mt-2 mb-2",children:s.jsx(R,{subscriptionTypes:(e==null?void 0:e.subscription_types)||[],className:"px-3 py-1 rounded-lg text-xs font-bold"})}),s.jsx("p",{className:"my-4 w-11/12 text-sm text-center md:my-2 md:text-base",children:e==null?void 0:e.bio}),s.jsxs("div",{className:"flex justify-between items-center w-full md:w-11/12",children:[s.jsxs("p",{className:"text-xs md:text-sm",children:[n("user.karma"),": ",e==null?void 0:e.karma.user_karma]}),s.jsxs("p",{className:"text-xs md:text-sm",children:[n("user.cakeDayOn"),": ",new Date(e==null?void 0:e.registrationDate).toDateString()]})]})]})]}),s.jsxs("div",{className:"flex flex-col my-2 text-sm md:text-sm",children:[s.jsxs("div",{className:"flex justify-between space-x-2",children:[s.jsxs("p",{className:"",children:[n("user.totalPosts"),": ",e==null?void 0:e.karma.posts_count]}),s.jsxs("p",{className:"",children:[n("user.postsKarma"),": ",e==null?void 0:e.karma.posts_karma]})]}),s.jsxs("div",{className:"flex justify-between space-x-2",children:[s.jsxs("p",{className:"",children:[n("user.totalComments"),": ",e==null?void 0:e.karma.comments_count]}),s.jsxs("p",{className:"",children:[n("user.commentsKarma"),": ",e==null?void 0:e.karma.comments_karma]})]})]})]})}),(e==null?void 0:e.deleted)&&!v&&s.jsx("div",{className:"flex flex-col items-center justify-center w-full min-h-96 bg-theme-less-white dark:bg-theme-dark-card rounded-md p-8 m-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("h1",{className:"text-3xl font-bold text-theme-text-primary mb-4",children:n("user.userNotExist")}),s.jsx("p",{className:"text-lg text-theme-text-secondary",children:n("user.userNotExistDescription")})]})}),!r&&s.jsx(F,{apiQueryKey:e==null?void 0:e.username,linkUrl:`posts/user/${e==null?void 0:e.username}`,enabled:(e==null?void 0:e.username)!==void 0}),s.jsx(O,{children:b!==!1&&s.jsx(z,{showModal:b,setShowModal:f,children:b})})]})}export{Z as Profile,Z as default};
