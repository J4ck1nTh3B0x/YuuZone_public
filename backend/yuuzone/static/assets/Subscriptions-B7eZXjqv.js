import{a as q,A as H,j as t,F as Q,J as X,V as Y,Q as h,c as Z,r as d,M as ee}from"./vendor_react_core-CNRJGlP_.js";import{a as v}from"./vendor_axios-NIGUFBhG.js";import"./vendor_other-Cv4PqGe0.js";import"./vendor_socket_io_client-ClWRkI5z.js";const te=({type:i,name:C,price:a,description:o,benefits:k=[],isOwned:M,expiresIn:B,onBuyClick:w,onBuyWithCoinsClick:p,image:J,isCurrentTier:G,coinCost:l})=>{var T;const{t:c}=q(),{user:N}=H(),x=typeof i=="string"?i:"free",A=typeof C=="string"?C:"Unknown",$=typeof a=="string"?a:"0 VND/month",S=typeof o=="string"?o:"",E=Array.isArray(k)?k:[],D=typeof M=="boolean"?M:!1,u=typeof B=="number"?B:null,f=typeof G=="boolean"?G:!1,b=w&&typeof w=="function"?w:null,g=p&&typeof p=="function"?p:null,O=typeof l=="number"?l:null,P=(()=>{if(O!==null)return O;const m=$.match(/(\d+(?:,\d+)*)/);if(m){const j=parseInt(m[1].replace(/,/g,""));return Math.ceil(j/100)}return null})(),I=((T=N==null?void 0:N.wallet)==null?void 0:T.coin_balance)||0,U=P&&I>=P,F=async()=>{var m,j;if(g)g(x);else try{(await v.post("/api/coins/tier/purchase",{tier_slug:x})).data.success&&(h.success(c("subscription.purchasedWithCoins")),window.dispatchEvent(new CustomEvent("userDataUpdated")))}catch(R){h.error(((j=(m=R.response)==null?void 0:m.data)==null?void 0:j.error)||c("subscription.purchaseWithCoinsError"))}};return t.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"bg-theme-bg-primary dark:bg-theme-dark-card rounded-2xl shadow-lg p-6 flex flex-col items-center text-center max-w-sm mx-auto",children:[t.jsx("div",{className:"mb-4 flex items-center justify-center",children:x==="support"?t.jsx(X,{className:"px-6 py-2 text-lg font-bold rounded-lg"}):x==="vip"?t.jsx(Y,{className:"px-6 py-2 text-lg font-bold rounded-lg"}):null}),t.jsx("h3",{className:"text-xl font-bold text-theme-text-primary dark:text-theme-dark-text mb-2",children:A}),t.jsx("p",{className:"text-theme-text-secondary dark:text-theme-dark-text-secondary text-sm mb-4 leading-relaxed",children:x==="free"?c("subscription.freeDescription"):x==="support"?c("subscription.supportDescription"):x==="vip"?c("subscription.vipDescription"):S}),t.jsx("div",{className:"w-full mb-6",children:t.jsx("ul",{className:"text-left space-y-2",children:(()=>{let m;try{return x==="free"?m=c("subscription.freeBenefits",{returnObjects:!0}):x==="support"?m=c("subscription.supportBenefits",{returnObjects:!0}):x==="vip"?m=c("subscription.vipBenefits",{returnObjects:!0}):m=E,Array.isArray(m)||(m=[]),m.map((j,R)=>t.jsxs("li",{className:"flex items-start text-sm text-theme-text-primary dark:text-theme-dark-text",children:[t.jsx("svg",{className:"w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),j]},R))}catch{return t.jsx("li",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:c("subscription.benefitsError")})}})()})}),t.jsx("div",{className:"text-2xl font-bold text-theme-blue mb-4",children:$}),f?t.jsxs("div",{className:"w-full",children:[t.jsx("div",{className:"bg-theme-bg-tertiary dark:bg-theme-dark-bg-secondary text-theme-text-secondary dark:text-theme-dark-text-secondary px-4 py-2 rounded-lg text-sm font-medium",children:c("subscription.youAreHere")}),u!==null&&t.jsx("div",{className:"text-xs text-theme-text-muted dark:text-theme-dark-text-secondary mt-2 text-center",children:u>0?t.jsx("span",{className:"text-green-600 dark:text-green-400",children:c("subscription.expiresIn",{days:u})}):t.jsx("span",{className:"text-red-600 dark:text-red-400",children:c("subscription.expired")})})]}):D?t.jsxs("div",{className:"w-full",children:[t.jsxs("div",{className:"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center",children:[t.jsx("svg",{className:"w-4 h-4 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),c("subscription.alreadyOwned")]}),u!==null&&t.jsx("div",{className:"text-xs text-theme-text-muted dark:text-theme-dark-text-secondary mt-2 text-center",children:u>0?t.jsx("span",{className:"text-green-600 dark:text-green-400",children:c("subscription.expiresIn",{days:u})}):t.jsx("span",{className:"text-red-600 dark:text-red-400",children:c("subscription.expired")})})]}):t.jsxs("div",{className:"w-full space-y-3",children:[t.jsx("button",{onClick:()=>b?b(x):null,className:`w-full font-medium py-3 px-6 rounded-lg transition-colors duration-200 transform hover:scale-105 ${b?"bg-theme-button-primary hover:bg-theme-button-primary-hover text-white":"bg-gray-400 text-gray-600 cursor-not-allowed"}`,disabled:!b,children:b?c("subscription.buyNow"):"Buy Now (Disabled)"}),P&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-center text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:c("subscription.or")}),t.jsxs("button",{onClick:F,disabled:!U,className:`w-full font-medium py-3 px-6 rounded-lg transition-colors duration-200 transform hover:scale-105 ${U?"bg-yellow-500 hover:bg-yellow-600 text-white":"bg-gray-400 text-gray-600 cursor-not-allowed"}`,children:[t.jsxs("div",{className:"flex items-center justify-center",children:[t.jsx("span",{className:"mr-2",children:"ðŸª™"}),c("subscription.buyWithCoins")]}),t.jsxs("div",{className:"text-xs mt-1",children:[P," ",c("coins.coins")]}),!U&&t.jsx("div",{className:"text-xs mt-1 text-red-200",children:c("subscription.insufficientCoins",{required:P,current:I})})]})]})]})]})},ie=()=>{var z;const{t:i}=q(),C=Z(),{socket:a}=H(),[o,k]=d.useState(null),[M,B]=d.useState(!0),[w,p]=d.useState(!1),[J,G]=d.useState(null),[l,c]=d.useState(null),[N,x]=d.useState([]),[A,$]=d.useState(!1),[S,E]=d.useState(300),[D,u]=d.useState(!1),[f,b]=d.useState(!1),g=d.useRef(null),O=async e=>{console.log("ðŸ” DEBUG: Subscription page received socket payment_completed event:",e);const{payment_reference:s,payment_type:r,amount:n,tier_name:_,user_subscription_types:V}=e;if(r==="subscription"){console.log("ðŸ” DEBUG: Processing subscription payment completion via socket event"),b(!0),h.success(`${i("subscription.paymentCompleted")} - ${_||"Subscription"}`),p(!1),u(!1);try{const L=await v.get("/api/subscriptions/plans");L.data&&k(L.data)}catch{}C(`/payment-success/${s}`)}};d.useEffect(()=>{P(),I(),console.log("ðŸ” DEBUG: Subscription page mounted, socket connected:",a==null?void 0:a.connected)},[]),d.useEffect(()=>{console.log("ðŸ” DEBUG: Setting up socket listeners, socket connected:",a==null?void 0:a.connected);const e=()=>{a&&a.connected&&!f&&(console.log("ðŸ” DEBUG: Socket is connected, setting up listeners"),a.on("payment_completed",s=>{console.log("ðŸ” DEBUG: Subscription page received payment_completed socket event:",s),O(s)}))};return e(),a&&a.on("connect",()=>{console.log("ðŸ” DEBUG: Socket connected, setting up listeners"),e()}),()=>{a&&a.connected&&(a.off("payment_completed"),a.off("connect"))}},[a,f]),d.useEffect(()=>(D&&S>0&&(g.current=setInterval(()=>{E(e=>e<=1?(u(!1),h.error(i("subscription.paymentExpired")),p(!1),I(),0):e-1)},1e3)),()=>{g.current&&clearInterval(g.current)}),[D,S,i]),d.useEffect(()=>{let e;return D&&(l!=null&&l.payment_reference)&&S>0&&!f?(console.log("ðŸ” DEBUG: Starting automatic payment status check every 3 seconds"),e=setInterval(()=>{f||T(l.payment_reference,!0)},3e3)):f&&console.log("ðŸ” DEBUG: Payment completed, stopping automatic status check"),()=>{e&&(console.log("ðŸ” DEBUG: Cleaning up automatic payment status check timer"),clearInterval(e))}},[D,l==null?void 0:l.payment_reference,S,f]),d.useEffect(()=>{const e=async s=>{const{payment_reference:r,payment_type:n,amount:_,tier_name:V,user_subscription_types:L}=s.detail;if(console.log("ðŸ” DEBUG: Subscription page received paymentCompleted event:",{payment_reference:r,payment_type:n,amount:_,tier_name:V}),n==="subscription"){b(!0),h.success(`${i("subscription.paymentCompleted")} - ${V||"Subscription"}`),p(!1),u(!1);try{const y=await v.get("/api/subscriptions/plans");y.data&&k(y.data)}catch{}C(`/payment-success/${r}`)}};return f||window.addEventListener("paymentCompleted",e),()=>{window.removeEventListener("paymentCompleted",e)}},[C,i,f]),d.useEffect(()=>{const e=async s=>{const{tier_name:r,tier_slug:n,amount:_,currency:V,payment_status:L}=s;h.success(`${i("subscription.paymentCompleted")} - ${r||"Subscription"}`);try{const y=await v.get("/api/subscriptions/plans");y.data&&k(y.data)}catch(y){console.error("Failed to refresh subscription data:",y)}try{const y=await v.get("/api/user");y.data&&window.dispatchEvent(new CustomEvent("userDataUpdated",{detail:y.data}))}catch(y){console.error("Failed to refresh user data:",y)}};return!f&&a&&a.connected&&a.on("subscription_purchased",e),()=>{a&&a.connected&&a.off("subscription_purchased",e)}},[a,i,f]),d.useEffect(()=>{w||(u(!1),E(300),g.current&&clearInterval(g.current))},[w]);const W=e=>{const s=Math.floor(e/60),r=e%60;return`${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},P=async()=>{try{const e=await v.get("/api/subscriptions/plans");k(e.data)}catch{h.error(i("subscription.toastErrorFailedToLoadSubscriptionData"))}finally{B(!1)}},I=async()=>{try{const e=await v.get("/api/subscriptions/payment/pending");x(e.data.pending_payments||[])}catch{}},U=async e=>{var s,r;try{G(e),B(!0);const n=await v.get(`/api/subscriptions/payment/qr/${e}`);c(n.data),p(!0),E(300),u(!0),b(!1)}catch(n){(r=(s=n.response)==null?void 0:s.data)!=null&&r.error?h.error(n.response.data.error):h.error(i("subscription.toastErrorFailedToGeneratePaymentQR"))}finally{B(!1)}},F=e=>{var r;const s={qr_url:e.qr_url,amount:e.amount,package_name:e.package_name||e.tier_name,payment_reference:((r=e.notes)==null?void 0:r.replace("Payment reference: ",""))||"",expires_at:e.expires_at};c(s),p(!0),u(!0),b(!1),E(300),g.current&&clearInterval(g.current),g.current=setInterval(()=>{E(n=>n<=1?(u(!1),h.error(i("subscription.paymentExpired")),p(!1),0):n-1)},1e3)},T=async(e=null,s=!1)=>{const r=e||(l==null?void 0:l.payment_reference);if(r&&!A&&!f)try{$(!0);const n=await v.get(`/api/subscriptions/payment/status/${r}`);if(n.data.status==="completed"){b(!0),h.success(i("subscription.paymentCompleted")),p(!1),u(!1);try{const _=await v.get("/api/subscriptions/plans");_.data&&k(_.data)}catch{}C(`/payment-success/${r}`)}else n.data.is_expired&&(s||h.error(i("subscription.paymentExpired")),p(!1),u(!1),I())}catch(n){s||console.error("Error checking payment status:",n)}finally{$(!1)}},m=e=>e==="free"?!0:o!=null&&o.user_subscription_types?o.user_subscription_types.includes(e):!1,j=()=>{if(!(o!=null&&o.user_subscription_types)||o.user_subscription_types.length===0)return"free";const e={vip:3,support:2,free:1};let s="free",r=1;for(const n of o.user_subscription_types)e[n]>r&&(s=n,r=e[n]);return s},R=e=>{if(e==="free"||!(o!=null&&o.user_subscriptions))return null;const s=o.user_subscriptions.find(r=>r.tier_slug===e);return(s==null?void 0:s.days_remaining)??null},K=[...o!=null&&o.plans?Object.entries(o.plans).map(([e,s])=>{var n;const r=Math.ceil(s.price/100);return{type:e==="member"?"free":e,name:s.name,price:`${s.price.toLocaleString()} VND/month`,description:s.description,benefits:((n=s.features)==null?void 0:n.benefits)||[],coinCost:e==="member"?null:r}}):[]];return M?t.jsx("div",{className:"flex justify-center items-center min-h-screen",children:t.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-theme-blue"})}):t.jsx("div",{className:"min-h-screen dark:bg-theme-dark-bg py-12 px-4",children:t.jsxs("div",{className:"max-w-6xl mx-auto",children:[t.jsxs(Q.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"text-center mb-12",children:[t.jsx("h1",{className:"text-4xl font-bold text-theme-blue mb-4",children:i("subscription.subscriptions")}),t.jsx("p",{className:"text-theme-text-secondary dark:text-theme-dark-text-secondary text-lg max-w-2xl mx-auto",children:i("subscription.subscriptionDescription")})]}),N&&Array.isArray(N)&&N.length>0&&t.jsxs(Q.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"mb-8 p-4 bg-yellow-100 dark:bg-yellow-900 border border-yellow-400 dark:border-yellow-600 rounded-lg",children:[t.jsx("h3",{className:"text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2",children:i("subscription.pendingPayments")}),t.jsx("div",{className:"space-y-2",children:(N||[]).map((e,s)=>{var r,n;return t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsxs("span",{className:"text-yellow-700 dark:text-yellow-300",children:[(r=e.notes)==null?void 0:r.replace("Payment reference: ","")," - ",(n=e.amount)==null?void 0:n.toLocaleString()," VND"]}),t.jsx("div",{className:"flex gap-2",children:t.jsx("button",{onClick:()=>F(e),disabled:A,className:"px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs disabled:opacity-50",children:i("subscription.payNow")})})]},s)})})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto",children:K.map((e,s)=>t.jsx(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:s*.1},children:t.jsx(te,{type:e.type,name:e.name,price:e.price,description:e.description,benefits:e.benefits,isOwned:m(e.type),expiresIn:R(e.type),onBuyClick:U,isCurrentTier:e.type===j(),coinCost:e.coinCost})},e.type))}),w&&l&&t.jsx(ee,{showModal:w,setShowModal:p,children:t.jsxs("div",{className:"bg-white dark:bg-theme-dark-card rounded-lg p-6 max-w-md mx-auto",children:[t.jsx("h2",{className:"text-2xl font-bold text-theme-text-primary dark:text-theme-dark-text mb-4 text-center",children:i("subscription.paymentQR")}),t.jsx("div",{className:"text-center mb-4",children:t.jsx("img",{src:l.qr_url,alt:"Payment QR Code",className:"mx-auto border-2 border-theme-border-light dark:border-theme-dark-border rounded-lg"})}),t.jsxs("div",{className:"text-center mb-4",children:[t.jsx("p",{className:"text-lg font-bold text-theme-text-primary dark:text-theme-dark-text",children:l.package_name}),t.jsxs("p",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:[(z=l.amount)==null?void 0:z.toLocaleString()," VND"]}),t.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:[i("subscription.paymentReference"),": ",l.payment_reference]})]}),t.jsx("div",{className:"text-center mb-4",children:t.jsxs("div",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text-secondary",children:[i("subscription.timeRemaining"),": ",W(S)]})}),t.jsxs("div",{className:"flex flex-col space-y-2",children:[t.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 text-center",children:["Reference: ",l.payment_reference]}),t.jsx("button",{onClick:()=>p(!1),className:"w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-medium",children:i("common.cancel")})]})]})})]})})};export{ie as default};
