import{a as z,A as V,r as m,d as O,n as B,Q as E,j as e,S as P,v as X,g as Z,u as J,c as I,F as W,D as Y,h as ne,G as ae,I as ie,M as G,l as ce,H as oe}from"./vendor_react_core-CNRJGlP_.js";import{a as L}from"./vendor_axios-NIGUFBhG.js";import{a8 as H,P as R}from"./vendor_other-Cv4PqGe0.js";import{u as D,L as ue,N as de}from"./index-DpLneSuz.js";import"./vendor_socket_io_client-ClWRkI5z.js";ee.propTypes={mods:R.array,threadId:R.number,isOwner:R.bool,onOwnershipTransferred:R.func};function ee({mods:r,threadId:s,onOwnershipTransferred:x}){const{t:g}=z(),{socket:d,user:S}=V(),[y,U]=m.useState(r||[]),[A,Q]=m.useState(""),[k,p]=m.useState(null),{data:j,isFetching:i}=O({queryKey:["search/user",A],queryFn:async({signal:l})=>await L.get(`/api/user/search/${A}`,{signal:l}).then(c=>c.data),enabled:!!(A&&A.length>3)}),{data:b}=O({queryKey:["thread",s],queryFn:async()=>await L.get(`/api/thread/${s}`).then(l=>l.data),enabled:!!s});m.useEffect(()=>(H.setFocused(!1),()=>H.setFocused(!0)),[]),m.useEffect(()=>{b!=null&&b.threadData&&(U(b.threadData.modList||[]),p(b.threadData.currentUserRole))},[b]),m.useEffect(()=>{if(!d)return;const l=({thread_id:h,username:f})=>{h===s&&!y.some(n=>n.username===f)&&U(n=>[...n,{username:f,isMod:!0,isAdmin:!1,avatar:null}])},c=({thread_id:h,username:f})=>{h===s&&U(n=>n.filter(w=>w.username!==f))};return d.on("mod_added",l),d.on("mod_removed",c),()=>{d.off("mod_added",l),d.off("mod_removed",c)}},[d,s,y]);const{mutate:N}=B({mutationFn:async({username:l,isDelete:c=!1})=>c?await L.delete(`/api/thread/mod/${s}/${l}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}).then(h=>(U(y.filter(f=>f.username!==l)),h.data)).catch(h=>{var f,n,w,T;console.error("Error:",((n=(f=h.response)==null?void 0:f.data)==null?void 0:n.message)||h.message),E.error(`${h.message} - ${((T=(w=h.response)==null?void 0:w.data)==null?void 0:T.message)||""}, ${g("alerts.onlyAdminsCanRemoveThreadCreator")}`)}):await L.put(`/api/thread/mod/${s}/${l}`).then(h=>{const f=j==null?void 0:j.find(n=>n.username===l);if(f){const n={username:f.username,isMod:!0,isAdmin:!1,avatar:f.avatar||null};U([...y,n])}return h.data})}),{mutate:_}=B({mutationFn:async({username:l,ban:c=!0,reason:h="Unspecific Ban Reason"})=>c?await L.post(`/api/thread/${s}/ban/${l}`,{reason:h}):await L.post(`/api/thread/${s}/unban/${l}`),onSuccess:()=>{E.success(g("alerts.banUnbanActionSuccessful"))},onError:l=>{var c,h;E.error(((h=(c=l.response)==null?void 0:c.data)==null?void 0:h.message)||g("alerts.failedToBanUnbanUser"))}}),t=B({mutationFn:async l=>await L.post(`/api/thread/${s}/transfer-ownership/${l}`),onSuccess:l=>{E.success(l.message||g("alerts.ownershipTransferredSuccessfully")),x&&x()},onError:l=>{var c,h;E.error(((h=(c=l.response)==null?void 0:c.data)==null?void 0:h.message)||g("alerts.failedToTransferOwnership"))}});return k?e.jsxs("div",{className:"w-5/6 h-5/6 bg-theme-less-white rounded-md dark:bg-theme-dark-bg",children:[e.jsx("h1",{className:"pt-2 text-2xl font-semibold text-center text-theme-blue",children:"Mod Manager"}),e.jsx("ul",{className:"overflow-auto relative p-3 m-3 space-y-2 max-h-[40vh] list-none bg-theme-light-gray2 dark:bg-theme-dark-bg",children:y.map(l=>e.jsxs("li",{className:"flex justify-between items-center p-1 bg-theme-less-white dark:bg-theme-dark-card rounded-md cursor-pointer",children:[e.jsxs("span",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:l.username}),l.isAdmin&&e.jsx(P,{type:"crown-admin",external:!0,className:"w-8 h-8 text-theme-yellow-crown"}),l.isMod&&!l.isAdmin&&e.jsx(P,{type:"wrench-mod",external:!0,className:"w-5 h-5 text-theme-wine-wrench"})]}),e.jsxs("div",{className:"flex space-x-2",children:[k==="admin"&&l.username!==(S==null?void 0:S.username)&&e.jsx("button",{onClick:()=>{window.confirm(g("alerts.transferOwnershipConfirm",{username:l.username}))&&t.mutate(l.username)},className:"text-green-600 hover:underline",title:g("alerts.transferOwnership"),children:g("alerts.transferOwnership")}),k==="admin"&&l.username!==(S==null?void 0:S.username)&&e.jsx("button",{onClick:()=>{window.confirm(g("alerts.removeModConfirm",{username:l.username}))&&N({username:l.username,isDelete:!0})},className:"text-red-600 hover:underline",title:g("alerts.removeMod"),children:e.jsx(P,{type:"delete",className:"w-8 h-8 font-bold text-theme-blue"})}),(k==="admin"||k==="mod")&&l.username!==(S==null?void 0:S.username)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{const c=prompt(g("alerts.enterBanReason",{username:l.username}),g("alerts.unspecificBanReason"));c!==null&&window.confirm(g("alerts.banUserConfirm",{username:l.username}))&&_({username:l.username,ban:!0,reason:c})},className:"text-red-600 hover:underline",title:g("alerts.banUser"),children:g("alerts.banUser")}),e.jsx("button",{onClick:()=>{window.confirm(g("alerts.unbanUserConfirm",{username:l.username}))&&_({username:l.username,ban:!1})},className:"text-green-600 hover:underline",title:g("alerts.unbanUser"),children:g("alerts.unbanUser")})]})]})]},l.username))}),e.jsx("div",{className:"flex flex-col",children:k==="admin"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"username",id:"username",value:A,onChange:l=>Q(l.target.value),className:"p-2 mx-3 font-semibold border-2 md:mx-10",placeholder:"Enter username to add new mod"}),i?e.jsx("div",{className:"m-28",children:e.jsx(X,{forPosts:!0})}):j&&e.jsx("ul",{className:"overflow-auto relative p-4 m-3 space-y-2 md:max-h-[38vh] max-h-[45vh] list-none rounded-md bg-theme-light-gray2 dark:bg-theme-dark-card",children:j==null?void 0:j.map(l=>!y.some(c=>c.username===l.username)&&e.jsxs("li",{className:"flex justify-between items-center p-1 px-2 bg-theme-less-white dark:bg-theme-dark-card rounded-md cursor-pointer",onClick:()=>N({username:l.username}),children:[l.username,e.jsx(P,{type:"add",className:"w-8 h-8 font-bold text-theme-blue"})]},l.username))})]})})]}):null}function te(r){const{socket:s,user:x}=V(),g=Z(),d=J(),S=I(),y=m.useCallback(()=>{const c=g.pathname;return["/profile","/coin-shop","/subscription","/settings","/login","/register","/forgot-password","/verify-email","/password-reset","/account-deletion","/banned"].some(f=>c.startsWith(f))},[g.pathname]),U=m.useCallback(c=>{const{user_id:h}=c;d.setQueryData(["subthreadSubscribers",r],f=>Array.isArray(f)?f.filter(n=>n.id!==h):f),d.setQueryData(["subthread",r],f=>f!=null&&f.threadData?{...f,threadData:{...f.threadData,subscriberCount:Math.max(0,(f.threadData.subscriberCount||0)-1)}}:f)},[d,r]),A=m.useCallback(c=>{const{username:h,unbanned_by:f}=c;d.setQueryData(["subthreadSubscribers",r],n=>(Array.isArray(n),n))},[d,r]),Q=m.useCallback(c=>{const{subthread_id:h}=c;h===r&&(S(`/banned/${h}`),d.removeQueries(["thread",r]),d.removeQueries(["posts","thread",r]))},[S,d,r]),k=m.useCallback(c=>{const{subthread_id:h,unbanned_by:f}=c;h===r&&d.setQueryData(["thread",r],n=>n!=null&&n.threadData?{...n,threadData:{...n.threadData}}:n)},[d,r]),p=m.useCallback(c=>{const{thread_id:h,username:f}=c;h===r&&(d.setQueryData(["thread",r],n=>{if(!(n!=null&&n.threadData))return n;const w=n.threadData.modList||[];return w.includes(f)?n:{...n,threadData:{...n.threadData,modList:[...w,f]}}}),d.setQueryData(["subthreadSubscribers",r],n=>(Array.isArray(n),n)))},[d,r]),j=m.useCallback(c=>{const{thread_id:h,username:f}=c;h===r&&(d.setQueryData(["thread",r],n=>{if(!(n!=null&&n.threadData))return n;const w=n.threadData.modList||[];return{...n,threadData:{...n.threadData,modList:w.filter(T=>T!==f)}}}),d.setQueryData(["subthreadSubscribers",r],n=>(Array.isArray(n),n)))},[d,r]),i=m.useCallback(c=>{const{subthread_id:h,removed_by:f,role:n}=c;h===r&&d.setQueryData(["thread",r],w=>w!=null&&w.threadData?{...w,threadData:{...w.threadData}}:w)},[d,r]),b=m.useCallback(c=>{const{old_admin:h,new_admin:f}=c;d.setQueryData(["thread",r],n=>n!=null&&n.threadData?{...n,threadData:{...n.threadData,admin:f}}:n),d.setQueryData(["subthreadSubscribers",r],n=>(Array.isArray(n),n))},[d,r]),N=m.useCallback(c=>{const{subthread_id:h,new_admin:f}=c;h===r&&d.setQueryData(["thread",r],n=>n!=null&&n.threadData?{...n,threadData:{...n.threadData,admin:f}}:n)},[d,r]),_=m.useCallback(c=>{const{subthread_id:h,old_admin:f}=c;h===r&&d.setQueryData(["thread",r],n=>n!=null&&n.threadData?{...n,threadData:{...n.threadData,admin:x==null?void 0:x.username}}:n)},[d,r,x==null?void 0:x.username]);m.useEffect(()=>{if(s&&!y())return r&&s.emit("join",{room:r}),x!=null&&x.username&&s.emit("join",{room:`user_${x.username}`}),s.on("user_banned",U),s.on("user_unbanned",A),s.on("you_were_banned",Q),s.on("you_were_unbanned",k),s.on("mod_added",p),s.on("mod_removed",j),s.on("you_were_demoted",i),s.on("admin_transferred",b),s.on("you_lost_admin",N),s.on("you_became_admin",_),()=>{y()||(r&&s.emit("leave",{room:r}),x!=null&&x.username&&s.emit("leave",{room:`user_${x.username}`}),s.off("user_banned",U),s.off("user_unbanned",A),s.off("you_were_banned",Q),s.off("you_were_unbanned",k),s.off("mod_added",p),s.off("mod_removed",j),s.off("you_were_demoted",i),s.off("admin_transferred",b),s.off("you_lost_admin",N),s.off("you_became_admin",_))}},[s,r,x==null?void 0:x.username,U,A,Q,k,p,j,i,b,N,_,y]);const t=m.useCallback((c,h,f)=>{s&&s.emit("user_banned",{username:c,subthread_id:r,banned_by:h,reason:f})},[s,r]),l=m.useCallback((c,h)=>{s&&s.emit("user_unbanned",{username:c,subthread_id:r,unbanned_by:h})},[s,r]);return{emitUserBan:t,emitUserUnban:l}}re.propTypes={threadId:R.string.isRequired,onClose:R.func};function re({threadId:r,onClose:s}){var a,C,M;const{t:x}=z(),g=D(),[d,S]=m.useState("user-viewer"),[y,U]=m.useState(""),[A,Q]=m.useState(null),[k,p]=m.useState(""),[j,i]=m.useState(!1);te(r);const{data:b,isLoading:N,refetch:_}=O({queryKey:["user-management",r],queryFn:async()=>(await L.get(`/api/thread/${r}/user-management`)).data}),{data:t,isFetching:l}=O({queryKey:["search/user",y],queryFn:async({signal:o})=>await L.get(`/api/user/search/${y}`,{signal:o}).then($=>$.data),enabled:!!(y&&y.length>3)}),{data:c,isLoading:h,error:f}=O({queryKey:["subthreadSubscribers",r],queryFn:async()=>(await L.get(`/api/thread/${r}/subscribers`)).data,enabled:d==="user-viewer"}),n=B({mutationFn:async({username:o,reason:$})=>await L.post(`/api/thread/${r}/ban/${o}`,{reason:$}),onSuccess:()=>{_(),i(!1),p(""),Q(null),E.success(x("alerts.userBannedSuccessfully"))},onError:o=>{var $,F;E.error(((F=($=o.response)==null?void 0:$.data)==null?void 0:F.message)||x("alerts.failedToBanUser"))}}),w=B({mutationFn:async o=>await L.post(`/api/thread/${r}/unban/${o}`),onSuccess:()=>{_(),E.success(x("alerts.userUnbannedSuccessfully"))},onError:o=>{var $,F;E.error(((F=($=o.response)==null?void 0:$.data)==null?void 0:F.message)||x("alerts.failedToUnbanUser"))}}),{data:T,mutate:K}=B({mutationFn:async o=>(await L.get(`/api/thread/${r}/user/${o}/posts`)).data}),q=o=>{Q(o),i(!0)},v=()=>{A&&n.mutate({username:A,reason:k||x("alerts.unspecificBanReason")})},u=async o=>{await g(x("alerts.unbanUserConfirm",{username:o}))&&w.mutate(o)};return N?e.jsx("div",{className:"w-5/6 h-5/6 bg-theme-less-white dark:bg-theme-dark-bg rounded-md flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-theme-blue border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-theme-dark-text",children:"Loading users..."})]})}):e.jsxs("div",{className:"w-5/6 h-5/6 bg-theme-less-white dark:bg-theme-dark-bg rounded-md overflow-hidden dark:text-theme-dark-text",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-theme-border-light dark:border-theme-dark-border",children:[e.jsx("h1",{className:"text-2xl font-semibold text-theme-blue",children:"User Management"}),s&&e.jsx("button",{onClick:s,className:"text-theme-text-secondary hover:text-theme-text-primary dark:text-theme-dark-text dark:hover:text-theme-dark-text",children:e.jsx(P,{type:"close",className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex border-b border-theme-border-light dark:border-theme-dark-border",children:[e.jsxs("button",{onClick:()=>S("user-viewer"),className:`px-4 py-2 font-medium ${d==="user-viewer"?"text-theme-blue border-b-2 border-theme-blue":"text-theme-text-secondary hover:text-theme-blue dark:text-theme-dark-text dark:hover:text-theme-blue"}`,children:["User Viewer (",((a=b==null?void 0:b.subscribers)==null?void 0:a.length)||0,")"]}),e.jsxs("button",{onClick:()=>S("banned"),className:`px-4 py-2 font-medium ${d==="banned"?"text-theme-blue border-b-2 border-theme-blue":"text-theme-text-secondary hover:text-theme-blue dark:text-theme-dark-text dark:hover:text-theme-blue"}`,children:["Banned Users (",((C=b==null?void 0:b.banned_users)==null?void 0:C.length)||0,")"]}),e.jsx("button",{onClick:()=>S("search"),className:`px-4 py-2 font-medium ${d==="search"?"text-theme-blue border-b-2 border-theme-blue":"text-theme-text-secondary hover:text-theme-blue dark:text-theme-dark-text dark:hover:text-theme-blue"}`,children:"Search & Ban"})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4",children:[d==="user-viewer"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Users Joined This Subthread"}),h&&e.jsx("p",{children:"Loading..."}),f&&e.jsx("p",{className:"text-theme-error",children:"Unable to load the list of users at this time. Please try again later."}),!h&&c&&Array.isArray(c)&&c.length===0&&e.jsx("p",{children:"No users have joined this subthread yet."}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:c&&c.map(o=>e.jsx("div",{className:"p-3 bg-theme-light-gray2 dark:bg-theme-dark-card rounded-md border-b border-theme-border-light dark:border-theme-dark-border",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[o.avatar&&e.jsx("img",{src:o.avatar,alt:o.username,className:"w-8 h-8 rounded-md"}),e.jsx("span",{className:"font-medium",children:o.username})]})},o.id))})]}),d==="banned"&&e.jsx("div",{className:"space-y-2",children:(M=b==null?void 0:b.banned_users)==null?void 0:M.map(o=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-theme-error-light rounded-md border border-theme-error-border",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[o.avatar&&e.jsx("img",{src:o.avatar,alt:o.username,className:"w-8 h-8 rounded-md"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:o.username}),e.jsxs("div",{className:"text-sm text-theme-text-secondary",children:["Reason: ",o.reason]}),e.jsxs("div",{className:"text-xs text-theme-text-muted",children:["Banned: ",new Date(o.banned_at).toLocaleDateString()]})]})]}),e.jsx("button",{onClick:()=>u(o.username),className:"text-theme-success hover:underline text-sm",children:"Unban"})]},o.username))}),d==="search"&&e.jsxs("div",{children:[e.jsx("input",{type:"text",value:y,onChange:o=>U(o.target.value),className:"w-full p-2 border-2 rounded-md mb-4 bg-theme-less-white dark:bg-theme-dark-card dark:text-theme-dark-text border-theme-border-light dark:border-theme-dark-border",placeholder:"Search username to ban (even if not joined)"}),l?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(ue,{text:x("common.searching")})}):t&&e.jsx("div",{className:"space-y-2",children:t.map(o=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-theme-light-gray2 dark:bg-theme-dark-card rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[o.avatar&&e.jsx("img",{src:o.avatar,alt:o.username,className:"w-8 h-8 rounded-md"}),e.jsx("span",{className:"font-medium",children:o.username})]}),e.jsx("button",{onClick:()=>q(o.username),className:"text-theme-error hover:underline text-sm",children:"Ban User"})]},o.username))})]})]}),j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-theme-less-white dark:bg-theme-dark-card p-6 rounded-lg max-w-md w-full mx-4",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 text-theme-text-primary dark:text-theme-dark-text",children:["Ban User: ",A]}),e.jsx("textarea",{value:k,onChange:o=>p(o.target.value),className:"w-full p-2 border border-theme-border-light dark:border-theme-dark-border rounded-md mb-4 text-theme-text-primary dark:text-theme-dark-text bg-theme-less-white dark:bg-theme-dark-bg",rows:"3",placeholder:"Enter ban reason (optional)"}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:()=>i(!1),className:"px-4 py-2 text-theme-text-secondary hover:text-theme-text-primary dark:text-theme-dark-text dark:hover:text-theme-dark-text",children:"Cancel"}),e.jsx("button",{onClick:v,className:"px-4 py-2 bg-theme-error text-white rounded hover:bg-theme-error-dark",children:"Ban User"})]})]})}),T&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Posts by ",T.username," (",T.total_posts," posts, ",T.total_comments," comments)"]}),e.jsx("button",{onClick:()=>K(null),className:"text-theme-text-secondary hover:text-theme-text-primary",children:e.jsx(P,{type:"close",className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Posts:"}),(T.posts||[]).map(o=>e.jsxs("div",{className:"p-3 bg-theme-bg-secondary rounded mb-2",children:[e.jsx("div",{className:"font-medium",children:o.title}),e.jsx("div",{className:"text-sm text-theme-text-secondary",children:o.content}),e.jsx("div",{className:"text-xs text-theme-text-muted",children:new Date(o.created_at).toLocaleDateString()})]},o.id))]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Comments:"}),(T.comments||[]).map(o=>e.jsxs("div",{className:"p-3 bg-theme-bg-secondary rounded mb-2",children:[e.jsx("div",{className:"text-sm text-theme-text-secondary",children:o.content}),e.jsx("div",{className:"text-xs text-theme-text-muted",children:new Date(o.created_at).toLocaleDateString()})]},o.id))]})]})]})})]})}function le(r,s){const{socket:x}=V(),g=Z(),d=J(),S=m.useCallback(()=>{const p=g.pathname;return["/profile","/coin-shop","/subscription","/settings","/login","/register","/forgot-password","/verify-email","/password-reset","/account-deletion","/banned"].some(i=>p.startsWith(i))},[g.pathname]),y=m.useCallback(p=>{const{subthreadId:j}=p;j===r&&(console.log("ðŸŸ¢ Subthread joined event received in useRealtimeSubthread:",p),d.setQueryData(["thread",s],i=>i!=null&&i.threadData?{...i,threadData:{...i.threadData,subscriberCount:(i.threadData.subscriberCount||0)+1}}:i),d.setQueryData(["threads/all"],i=>{if(!i)return i;const b=N=>Array.isArray(N)?N.map(_=>_.id===r?{..._,subscriberCount:(_.subscriberCount||0)+1}:_):N;return{...i,subscribed:b(i.subscribed),all:b(i.all),popular:b(i.popular)}}),d.setQueryData(["subthreadSubscribers",r],i=>(Array.isArray(i),i)))},[d,r,s]),U=m.useCallback(p=>{const{subthreadId:j}=p;j===r&&(console.log("ðŸ”´ Subthread left event received in useRealtimeSubthread:",p),d.setQueryData(["thread",s],i=>i!=null&&i.threadData?{...i,threadData:{...i.threadData,subscriberCount:Math.max(0,(i.threadData.subscriberCount||0)-1)}}:i),d.setQueryData(["threads/all"],i=>{if(!i)return i;const b=N=>Array.isArray(N)?N.map(_=>_.id===r?{..._,subscriberCount:Math.max(0,(_.subscriberCount||0)-1)}:_):N;return{...i,subscribed:b(i.subscribed),all:b(i.all),popular:b(i.popular)}}),d.setQueryData(["subthreadSubscribers",r],i=>(Array.isArray(i),i)))},[d,r,s]),A=m.useCallback(p=>{const{id:j,name:i,description:b,logo:N}=p,_={id:j,name:i,description:b,logo:N};d.setQueryData(["subthreads"],t=>Array.isArray(t)?[_,...t]:[_])},[d]),Q=m.useCallback(p=>{const{id:j,updated_fields:i}=p;d.setQueryData(["subthreads"],b=>Array.isArray(b)?b.map(N=>N.id===j?{...N,...i}:N):b)},[d]);return m.useEffect(()=>{if(x&&!S())return r&&x.emit("join",{room:r}),x.on("subthread_joined",y),x.on("subthread_left",U),x.on("subthread_created",A),x.on("subthread_updated",Q),()=>{S()||(r&&x.emit("leave",{room:r}),x.off("subthread_joined",y),x.off("subthread_left",U),x.off("subthread_created",A),x.off("subthread_updated",Q))}},[x,r,y,U,A,Q,S]),{emitSubthreadUpdate:m.useCallback((p,j)=>{x&&x.emit("subthread_updated",{subthread_id:r,updated_fields:p,updated_by:j})},[x,r])}}function me(r={}){const{socket:s}=V(),x=J(),[g,d]=m.useState(0),[S,y]=m.useState([]),[U,A]=m.useState([]),[Q,k]=m.useState(null),[p,j]=m.useState([]),i=m.useRef(new Map),{subthreadId:b,enableLiveUserCount:N=!0,enableUserActivity:_=!0,enableSystemStatus:t=!0,activityTimeout:l=3e4,maxActivityItems:c=50}=r,h=m.useCallback(u=>{const{user_count:a,active_users:C}=u;d(a),y(C||[])},[]),f=m.useCallback(u=>{const{username:a,activity_type:C,timestamp:M}=u;A(o=>[{username:a,activity_type:C,timestamp:M||new Date().toISOString(),id:Date.now()+Math.random()},...o].slice(0,c)),i.current.has(a)&&clearTimeout(i.current.get(a)),i.current.set(a,setTimeout(()=>{A(o=>o.filter($=>$.username!==a)),i.current.delete(a)},l))},[c]),n=m.useCallback(u=>{const{status_type:a,message:C,severity:M,timestamp:o}=u;k({type:a,message:C,severity:M,timestamp:o||new Date().toISOString()})},[]),w=m.useCallback(u=>{const{metrics_type:a,value:C,threshold:M,timestamp:o}=u;j($=>[{type:a,value:C,threshold:M,timestamp:o||new Date().toISOString(),id:Date.now()+Math.random()},...$].slice(0,10))},[]),T=m.useCallback(u=>{const{stats_type:a,new_value:C,updated_by:M}=u;b&&x.setQueryData(["thread",b],o=>{if(!(o!=null&&o.threadData))return o;const $={...o.threadData};switch(a){case"posts_count":$.PostsCount=Math.max(0,($.PostsCount||0)+C);break;case"subscriber_count":$.subscriberCount=Math.max(0,($.subscriberCount||0)+C);break;case"active_users":$.activeUsers=C;break}return{...o,threadData:$}})},[x,b]),K=m.useCallback((u,a=null)=>{s&&s.emit("user_activity",{activity_type:u,subthread_id:b,post_id:a,timestamp:new Date().toISOString()})},[s,b]),q=m.useCallback((u,a)=>{s&&s.emit("post_shared",{post_id:u,share_platform:a,subthread_id:b})},[s,b]),v=m.useCallback((u,a,C,M)=>{s&&s.emit("mention",{mentioned_user:u,post_id:a,comment_id:C,content:M})},[s]);return m.useEffect(()=>{if(Q){const u=setTimeout(()=>{k(null)},5e3);return()=>clearTimeout(u)}},[Q]),m.useEffect(()=>{if(p&&Array.isArray(p)&&p.length>0){const u=setTimeout(()=>{j(a=>a.slice(1))},1e4);return()=>clearTimeout(u)}},[p]),m.useEffect(()=>{if(s)return b&&s.emit("join",{room:b}),N&&s.on("live_user_count_updated",h),_&&s.on("user_activity",f),t&&(s.on("system_status_update",n),s.on("performance_alert",w)),s.on("subthread_stats_updated",T),()=>{b&&s.emit("leave",{room:b}),s.off("live_user_count_updated",h),s.off("user_activity",f),s.off("system_status_update",n),s.off("performance_alert",w),s.off("subthread_stats_updated",T),i.current.forEach(u=>clearTimeout(u)),i.current.clear()}},[s,b,N,_,t,h,f,n,w,T]),{liveUserCount:g,activeUsers:S,userActivity:U,systemStatus:Q,performanceAlerts:p,emitUserActivity:K,emitPostShare:q,emitMention:v,clearSystemStatus:()=>k(null),clearPerformanceAlerts:()=>j([]),clearUserActivity:()=>A([])}}se.propTypes={subthreadId:R.string,showUserCount:R.bool,showActivity:R.bool,showSystemStatus:R.bool,maxActivityItems:R.number,className:R.string};function se({subthreadId:r,showUserCount:s=!0,showActivity:x=!0,showSystemStatus:g=!0,maxActivityItems:d=5,className:S=""}){const{t:y}=z(),[U,A]=m.useState(!1),{liveUserCount:Q,activeUsers:k,userActivity:p,systemStatus:j,performanceAlerts:i,emitUserActivity:b}=me({subthreadId:r,enableLiveUserCount:s,enableUserActivity:x,enableSystemStatus:g,maxActivityItems:d});m.useEffect(()=>{r&&b("browsing")},[r,b]);const N=c=>{switch(c){case"posting":return"ðŸ“";case"commenting":return"ðŸ’¬";case"voting":return"ðŸ‘";case"browsing":return"ðŸ‘€";case"joining":return"âž•";case"leaving":return"âž–";default:return"ðŸ‘¤"}},_=c=>{switch(c){case"posting":return y("activity.posting");case"commenting":return y("activity.commenting");case"voting":return y("activity.voting");case"browsing":return y("activity.browsing");case"joining":return y("activity.joining");case"leaving":return y("activity.leaving");default:return y("activity.unknown")}},t=c=>{switch(c){case"error":return"text-red-500 bg-red-50 border-red-200";case"warning":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"info":return"text-blue-600 bg-blue-50 border-blue-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},l=c=>{switch(c){case"maintenance":return"ðŸ”§";case"performance":return"âš¡";case"error":return"âš ï¸";default:return"â„¹ï¸"}};return!s&&!x&&!g?null:e.jsxs("div",{className:`live-activity-indicator ${S}`,children:[s&&Q>0&&e.jsxs(W.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300 mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:y("live.users",{count:Q})}),k.length>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:["(",k.slice(0,3).join(", "),k.length>3?"...":"",")"]})]}),e.jsx(Y,{children:g&&j&&e.jsx(W.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:`p-2 rounded-lg border text-sm mb-2 ${t(j.severity)}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:l(j.type)}),e.jsx("span",{className:"font-medium",children:j.message})]})})}),e.jsx(Y,{children:g&&i.length>0&&e.jsx(W.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"p-2 rounded-lg border border-orange-200 bg-orange-50 text-orange-700 text-sm mb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"âš¡"}),e.jsx("span",{children:y("performance.alert")})]})})}),x&&p.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("button",{onClick:()=>A(!U),className:"text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors",children:[y(U?"activity.hide":"activity.show")," (",p.length,")"]}),e.jsx(Y,{children:U&&e.jsx(W.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-1",children:p.slice(0,d).map(c=>e.jsxs(W.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},className:"flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400",children:[e.jsx("span",{children:N(c.activity_type)}),e.jsx("span",{className:"font-medium",children:c.username}),e.jsx("span",{children:_(c.activity_type)}),e.jsx("span",{className:"text-gray-400",children:new Date(c.timestamp).toLocaleTimeString()})]},c.id))})})]})]})}function ye(){const{t:r}=z(),s=I(),{isAuthenticated:x,user:g}=V(),d=D(),[S,y]=m.useState(null),[U,A]=m.useState(!1),Q=m.useRef(null),k=J(),p=ne(),j=p.threadName,[i,b]=m.useState(null);le(j,p.threadName),te(j);const{data:N,isFetching:_}=O({queryKey:["thread",p.threadName],queryFn:async()=>{try{return await L.get(`/api/threads/${p.threadName}`).then(v=>v.data)}catch(v){if(oe(v,s))return null;throw v}},staleTime:5*60*1e3,gcTime:10*60*1e3,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1});m.useEffect(()=>(document.title="t/"+p.threadName,()=>{document.title="yuuzone"}),[p.threadName]);const t=N==null?void 0:N.threadData;m.useEffect(()=>{t!=null&&t.id&&b(t.id)},[t==null?void 0:t.id]);const l=t==null?void 0:t.currentUserRole,c=(t==null?void 0:t.currentUserRoles)||[],h=c.includes("admin")||l==="admin",f=c.includes("mod")||l==="mod",{connected:n,socket:w}=ae(t==null?void 0:t.name);m.useEffect(()=>{if(n)return w.on("new_post",()=>{k.setQueryData(["thread",p.threadName],v=>v&&{...v,threadData:{...v.threadData,PostsCount:v.threadData.PostsCount+1}})}),w.on("subthread_joined",({subthreadId:v})=>{i&&v===i&&(console.log("ðŸŸ¢ Subthread joined event received in SubThread:",v),k.setQueryData(["thread",p.threadName],u=>u&&{...u,threadData:{...u.threadData,subscriberCount:u.threadData.subscriberCount+1}}),k.setQueryData(["threads/all"],u=>{if(!u)return u;const a=C=>Array.isArray(C)?C.map(M=>M.id===i?{...M,subscriberCount:(M.subscriberCount||0)+1}:M):C;return{...u,subscribed:a(u.subscribed),all:a(u.all),popular:a(u.popular)}}))}),w.on("subthread_left",({subthreadId:v})=>{i&&v===i&&(console.log("ðŸ”´ Subthread left event received in SubThread:",v),k.setQueryData(["thread",p.threadName],u=>u&&{...u,threadData:{...u.threadData,subscriberCount:Math.max(0,u.threadData.subscriberCount-1)}}),k.setQueryData(["threads/all"],u=>{if(!u)return u;const a=C=>Array.isArray(C)?C.map(M=>M.id===i?{...M,subscriberCount:Math.max(0,(M.subscriberCount||0)-1)}:M):C;return{...u,subscribed:a(u.subscribed),all:a(u.all),popular:a(u.popular)}}))}),w.on("mod_added",({thread_id:v,username:u})=>{i&&v===i&&k.setQueryData(["thread",p.threadName],a=>{if(!a)return a;const C=a.threadData.modList?[...a.threadData.modList,u]:[u];return{...a,threadData:{...a.threadData,modList:C}}})}),w.on("mod_removed",({thread_id:v,username:u})=>{i&&v===i&&k.setQueryData(["thread",p.threadName],a=>{if(!a)return a;const C=a.threadData.modList?a.threadData.modList.filter(M=>M.username!==u):[];return{...a,threadData:{...a.threadData,modList:C}}})}),()=>{w.off("new_post"),w.off("subthread_joined"),w.off("subthread_left"),w.off("mod_added"),w.off("mod_removed")}},[n,w,k,p.threadName,t==null?void 0:t.id]);const{mutate:T}=B({mutationFn:async v=>{v?L.delete(`/api/threads/subscription/${t.id}`).then(()=>k.setQueryData(["thread",p.threadName],u=>({threadData:{...u.threadData,has_subscribed:!1}}))):L.post(`/api/threads/subscription/${t.id}`).then(()=>k.setQueryData(["thread",p.threadName],u=>({threadData:{...u.threadData,has_subscribed:!0}})))}}),K=B({mutationFn:async()=>await L.delete(`/api/thread/${t.id}`),onSuccess:()=>{s("/")},onError:v=>{var u,a;E.error(((a=(u=v.response)==null?void 0:u.data)==null?void 0:a.message)||r("alerts.unableToDeleteSubthread"))}});if(t!=null&&t.is_banned)return s(`/banned/${t.id}`),null;function q(v){switch(v){case"more":break;case"edit":y(e.jsx(de,{ogInfo:t,edit:!0,setShowModal:y}));break;case"manage-mods":{const u=(t.modList||[]).map(a=>typeof a=="string"?{username:a}:a);y(e.jsx(ee,{mods:u,threadId:t.id}));break}case"user-management":y(e.jsx(re,{threadId:t.id,onClose:()=>y(null)}));break;case"delete":{d(r("alerts.deleteSubthreadConfirm"))&&K.mutate();break}case"logo":y(e.jsx("img",{src:t==null?void 0:t.logo,className:"object-cover w-11/12 max-h-5/6 md:w-max md:max-h-screen",alt:""}));break;default:s(`/u/${v}`)}Q.current.value="more"}return e.jsxs("div",{className:"flex flex-col flex-1 items-center w-full bg-theme-light-gray2 dark:bg-theme-dark-bg dark:text-theme-dark-text",children:[e.jsxs("div",{className:"flex flex-col p-5 space-y-1 w-full bg-theme-less-white dark:bg-theme-dark-card rounded-md md:pb-3 md:space-y-3",children:[_?e.jsx(X,{forPosts:!0}):e.jsxs("div",{className:`flex p-2 flex-col md:flex-row items-center rounded-md md:rounded-md bg-theme-light-gray2 dark:bg-theme-dark-bg ${!(t!=null&&t.logo)&&"py-5"}`,children:[(t==null?void 0:t.logo)&&e.jsx("img",{src:t==null?void 0:t.logo,className:"object-cover w-32 h-32 rounded-md cursor-pointer md:w-36 md:h-36",alt:"",onClick:()=>q("logo")}),e.jsxs("div",{className:"flex flex-col flex-1 justify-around items-center p-2 space-y-1",children:[e.jsx("div",{className:"flex items-center space-x-5",children:e.jsx("h1",{className:"text-xl font-semibold text-theme-text-primary dark:text-theme-dark-text",children:t==null?void 0:t.name})}),e.jsxs("p",{className:"text-lg text-theme-text-secondary dark:text-theme-dark-text",children:["Since: ",new Date(t==null?void 0:t.created_at).toDateString()]}),(t==null?void 0:t.description)&&e.jsxs("p",{className:`text-center py-4 md:py-2 text-sm dark:text-theme-dark-text ${(t==null?void 0:t.description.length)>90&&"text-lg"}`,children:[t==null?void 0:t.description,(t==null?void 0:t.description.length)>90&&"..."]}),e.jsxs("div",{className:"flex justify-between mt-2 space-x-7 w-full md:w-11/12",children:[e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:[t==null?void 0:t.subscriberCount," subscribers"]}),e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:[t==null?void 0:t.PostsCount," posts"]}),e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:[t==null?void 0:t.CommentsCount," comments"]})]}),e.jsx(se,{subthreadId:i,showUserCount:!0,showActivity:!0,showSystemStatus:!0,maxActivityItems:3,className:"mt-3"})]})]}),e.jsxs("div",{className:"flex flex-col justify-around space-y-3 md:space-x-10 md:flex-row md:space-y-0",children:[e.jsx("div",{className:"flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-4",children:x&&e.jsx("button",{className:`px-32 py-2 text-white rounded-md active:scale-90 ${t!=null&&t.has_subscribed?"bg-blue-400":"bg-theme-blue-coral"} dark:bg-theme-blue-coral`,onClick:()=>T(t==null?void 0:t.has_subscribed),disabled:(t==null?void 0:t.created_by)===g.id&&(t==null?void 0:t.modList.length)>0,title:(t==null?void 0:t.created_by)===g.id&&(t==null?void 0:t.modList.length)>0?r("subthreads.transferOwnershipBeforeLeaving"):"",children:t!=null&&t.has_subscribed?r("subthreads.leave"):r("subthreads.join")})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("select",{ref:Q,defaultValue:"more",onChange:v=>q(v.target.value),name:"mods",id:"mods",className:"px-3 py-1 text-center text-2xl font-extrabold rounded-md md:block bg-transparent appearance-none cursor-pointer border-none outline-none dark:text-white focus:outline-none focus:ring-0 focus:border-none",style:{backgroundImage:"none",outline:"none",boxShadow:"none"},children:[e.jsx("option",{value:"more",className:"text-base font-normal dark:text-white dark:bg-theme-dark-card",style:{display:"none"},children:"â‹¯"}),x&&(h||g.id===(t==null?void 0:t.created_by))&&e.jsxs("optgroup",{label:r("subthreads.adminOptions"),className:"text-lg font-bold dark:text-white",children:[e.jsx("option",{value:"edit",className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:r("subthreads.editSubthread")}),e.jsx("option",{value:"manage-mods",className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:r("subthreads.manageMods")}),e.jsx("option",{value:"user-management",className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:r("moderation.userManagement")}),e.jsx("option",{value:"delete",className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:r("subthreads.deleteSubthread")})]}),x&&f&&!h&&g.id!==(t==null?void 0:t.created_by)&&e.jsx("optgroup",{label:r("moderation.moderatorOptions"),className:"text-lg font-bold dark:text-white",children:e.jsx("option",{value:"user-management",className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:r("moderation.userManagement")})}),(()=>{if(!t)return null;const v=t.created_by_username?[t.created_by_username]:[],u=t.modList.filter(a=>!v.includes(typeof a=="string"?a:a.username||a));return e.jsxs(e.Fragment,{children:[e.jsx("optgroup",{label:r("moderation.subthreadAdmin"),className:"text-lg font-bold dark:text-white",children:v.length>0?v.map(a=>e.jsx("option",{value:a,className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:a},a)):e.jsx("option",{value:"abandoned",className:"text-lg font-normal text-theme-text-muted dark:text-theme-text-secondary dark:bg-theme-dark-card",children:r("moderation.abandoned")})}),e.jsx("optgroup",{label:r("moderation.subthreadMods"),className:"text-lg font-bold dark:text-white",children:u.map(a=>e.jsx("option",{value:typeof a=="string"?a:a.username||a,className:"text-lg font-normal dark:text-white dark:bg-theme-dark-card",children:typeof a=="string"?a:a.username||a},typeof a=="string"?a:a.username||a))})]})})()]}),x&&(h||g.id===(t==null?void 0:t.created_by)||f)&&e.jsxs(e.Fragment,{children:[h&&e.jsx(P,{type:"crown-admin",external:!0,className:"w-8 h-8 ml-2 text-theme-yellow-crown"}),f&&!h&&e.jsx(P,{type:"wrench-mod",external:!0,className:"w-5 h-5 ml-2 text-theme-wine-wrench"})]})]})]})]}),e.jsx(ie,{apiQueryKey:t==null?void 0:t.name,linkUrl:`posts/thread/${t==null?void 0:t.id}`,enabled:t!==void 0}),e.jsxs(Y,{children:[S&&e.jsx(G,{setShowModal:y,children:S}),U&&e.jsx(G,{setShowModal:A,children:e.jsx(ce,{setShowModal:A,threadInfo:{thread_id:t==null?void 0:t.id,thread_name:t==null?void 0:t.name}})})]})]})}export{ye as SubThread,ye as default};
