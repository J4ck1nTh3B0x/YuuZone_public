import{a as W,A as V,r as l,d as Y,n as q,Q as F,j as e,S as P,v as X,u as J,c as Z,B as K,y as z,i as re,C as ne,I as ae,M as G,l as ie,D as oe}from"./vendor_react_core-BQ601SDD.js";import{a as M}from"./vendor_axios-NIGUFBhG.js";import{a8 as H,P as E}from"./vendor_other-CYhXLBgr.js";import{u as I,L as ce,N as me}from"./index-B4WczAw1.js";import"./vendor_socket_io_client-BJzX-5m1.js";D.propTypes={mods:E.array,threadId:E.number,isOwner:E.bool,onOwnershipTransferred:E.func};function D({mods:r,threadId:n,onOwnershipTransferred:d}){const{t:o}=W(),{socket:w,user:k}=V(),[f,S]=l.useState(r||[]),[A,N]=l.useState(""),[h,m]=l.useState(null),{data:g,isFetching:j}=Y({queryKey:["search/user",A],queryFn:async({signal:a})=>await M.get(`/api/user/search/${A}`,{signal:a}).then(i=>i.data),enabled:!!(A&&A.length>3)}),{data:b}=Y({queryKey:["thread",n],queryFn:async()=>await M.get(`/api/thread/${n}`).then(a=>a.data),enabled:!!n});l.useEffect(()=>(H.setFocused(!1),()=>H.setFocused(!0)),[]),l.useEffect(()=>{b!=null&&b.threadData&&(S(b.threadData.modList||[]),m(b.threadData.currentUserRole))},[b]),l.useEffect(()=>{if(!w)return;const a=({thread_id:s,username:x})=>{s===n&&!f.some($=>$.username===x)&&S($=>[...$,{username:x,isMod:!0,isAdmin:!1,avatar:null}])},i=({thread_id:s,username:x})=>{s===n&&S($=>$.filter(B=>B.username!==x))};return w.on("mod_added",a),w.on("mod_removed",i),()=>{w.off("mod_added",a),w.off("mod_removed",i)}},[w,n,f]);const{mutate:t}=q({mutationFn:async({username:a,isDelete:i=!1})=>i?await M.delete(`/api/thread/mod/${n}/${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}).then(s=>(S(f.filter(x=>x.username!==a)),s.data)).catch(s=>{var x,$,B,L;console.error("Error:",(($=(x=s.response)==null?void 0:x.data)==null?void 0:$.message)||s.message),F.error(`${s.message} - ${((L=(B=s.response)==null?void 0:B.data)==null?void 0:L.message)||""}, ${o("alerts.onlyAdminsCanRemoveThreadCreator")}`)}):await M.put(`/api/thread/mod/${n}/${a}`).then(s=>{const x=g==null?void 0:g.find($=>$.username===a);if(x){const $={username:x.username,isMod:!0,isAdmin:!1,avatar:x.avatar||null};S([...f,$])}return s.data})}),{mutate:T}=q({mutationFn:async({username:a,ban:i=!0,reason:s="Unspecific Ban Reason"})=>i?await M.post(`/api/thread/${n}/ban/${a}`,{reason:s}):await M.post(`/api/thread/${n}/unban/${a}`),onSuccess:()=>{F.success(o("alerts.banUnbanActionSuccessful"))},onError:a=>{var i,s;F.error(((s=(i=a.response)==null?void 0:i.data)==null?void 0:s.message)||o("alerts.failedToBanUnbanUser"))}}),p=q({mutationFn:async a=>await M.post(`/api/thread/${n}/transfer-ownership/${a}`),onSuccess:a=>{F.success(a.message||o("alerts.ownershipTransferredSuccessfully")),d&&d()},onError:a=>{var i,s;F.error(((s=(i=a.response)==null?void 0:i.data)==null?void 0:s.message)||o("alerts.failedToTransferOwnership"))}});return h?e.jsxs("div",{className:"w-5/6 h-5/6 bg-theme-less-white rounded-md dark:bg-theme-dark-bg",children:[e.jsx("h1",{className:"pt-2 text-2xl font-semibold text-center text-theme-blue",children:"Mod Manager"}),e.jsx("ul",{className:"overflow-auto relative p-3 m-3 space-y-2 max-h-[40vh] list-none bg-theme-light-gray2 dark:bg-theme-dark-bg",children:f.map(a=>e.jsxs("li",{className:"flex justify-between items-center p-1 bg-theme-less-white dark:bg-theme-dark-card rounded-md cursor-pointer",children:[e.jsxs("span",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:a.username}),a.isAdmin&&e.jsx(P,{type:"crown-admin",external:!0,className:"w-8 h-8 text-theme-yellow-crown"}),a.isMod&&!a.isAdmin&&e.jsx(P,{type:"wrench-mod",external:!0,className:"w-5 h-5 text-theme-wine-wrench"})]}),e.jsxs("div",{className:"flex space-x-2",children:[h==="admin"&&a.username!==(k==null?void 0:k.username)&&e.jsx("button",{onClick:()=>{window.confirm(o("alerts.transferOwnershipConfirm",{username:a.username}))&&p.mutate(a.username)},className:"text-green-600 hover:underline",title:o("alerts.transferOwnership"),children:o("alerts.transferOwnership")}),h==="admin"&&a.username!==(k==null?void 0:k.username)&&e.jsx("button",{onClick:()=>{window.confirm(o("alerts.removeModConfirm",{username:a.username}))&&t({username:a.username,isDelete:!0})},className:"text-red-600 hover:underline",title:o("alerts.removeMod"),children:e.jsx(P,{type:"delete",className:"w-8 h-8 font-bold text-theme-blue"})}),(h==="admin"||h==="mod")&&a.username!==(k==null?void 0:k.username)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{const i=prompt(o("alerts.enterBanReason",{username:a.username}),o("alerts.unspecificBanReason"));i!==null&&window.confirm(o("alerts.banUserConfirm",{username:a.username}))&&T({username:a.username,ban:!0,reason:i})},className:"text-red-600 hover:underline",title:o("alerts.banUser"),children:o("alerts.banUser")}),e.jsx("button",{onClick:()=>{window.confirm(o("alerts.unbanUserConfirm",{username:a.username}))&&T({username:a.username,ban:!1})},className:"text-green-600 hover:underline",title:o("alerts.unbanUser"),children:o("alerts.unbanUser")})]})]})]},a.username))}),e.jsx("div",{className:"flex flex-col",children:h==="admin"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",name:"username",id:"username",value:A,onChange:a=>N(a.target.value),className:"p-2 mx-3 font-semibold border-2 md:mx-10",placeholder:"Enter username to add new mod"}),j?e.jsx("div",{className:"m-28",children:e.jsx(X,{forPosts:!0})}):g&&e.jsx("ul",{className:"overflow-auto relative p-4 m-3 space-y-2 md:max-h-[38vh] max-h-[45vh] list-none rounded-md bg-theme-light-gray2 dark:bg-theme-dark-card",children:g==null?void 0:g.map(a=>!f.some(i=>i.username===a.username)&&e.jsxs("li",{className:"flex justify-between items-center p-1 px-2 bg-theme-less-white dark:bg-theme-dark-card rounded-md cursor-pointer",onClick:()=>t({username:a.username}),children:[a.username,e.jsx(P,{type:"add",className:"w-8 h-8 font-bold text-theme-blue"})]},a.username))})]})})]}):null}function ee(r){const{socket:n,user:d}=V(),o=J(),w=Z(),k=l.useCallback(p=>{const{user_id:a}=p;o.setQueryData(["subthreadSubscribers",r],i=>Array.isArray(i)?i.filter(s=>s.id!==a):i),o.setQueryData(["subthread",r],i=>i!=null&&i.threadData?{...i,threadData:{...i.threadData,subscriberCount:Math.max(0,(i.threadData.subscriberCount||0)-1)}}:i),console.log(`User ${a} was banned`)},[o,r]),f=l.useCallback(p=>{const{username:a,unbanned_by:i}=p;o.setQueryData(["subthreadSubscribers",r],s=>(Array.isArray(s),s)),console.log(`User ${a} was unbanned by ${i}`)},[o,r]),S=l.useCallback(p=>{const{subthread_id:a}=p;a===r&&(w(`/banned/${a}`),o.removeQueries(["thread",r]),o.removeQueries(["posts","thread",r]))},[w,o,r]),A=l.useCallback(p=>{const{subthread_id:a,unbanned_by:i}=p;a===r&&(o.setQueryData(["thread",r],s=>s!=null&&s.threadData?{...s,threadData:{...s.threadData}}:s),console.log(`You were unbanned from this subthread by ${i}`))},[o,r]),N=l.useCallback(p=>{const{thread_id:a,username:i}=p;a===r&&(o.setQueryData(["thread",r],s=>{if(!(s!=null&&s.threadData))return s;const x=s.threadData.modList||[];return x.includes(i)?s:{...s,threadData:{...s.threadData,modList:[...x,i]}}}),o.setQueryData(["subthreadSubscribers",r],s=>(Array.isArray(s),s)))},[o,r]),h=l.useCallback(p=>{const{thread_id:a,username:i}=p;a===r&&(o.setQueryData(["thread",r],s=>{if(!(s!=null&&s.threadData))return s;const x=s.threadData.modList||[];return{...s,threadData:{...s.threadData,modList:x.filter($=>$!==i)}}}),o.setQueryData(["subthreadSubscribers",r],s=>(Array.isArray(s),s)))},[o,r]),m=l.useCallback(p=>{const{subthread_id:a,removed_by:i,role:s}=p;a===r&&(o.setQueryData(["thread",r],x=>x!=null&&x.threadData?{...x,threadData:{...x.threadData}}:x),console.log(`You were removed as ${s} by ${i}`))},[o,r]),g=l.useCallback(p=>{const{old_admin:a,new_admin:i}=p;o.setQueryData(["thread",r],s=>s!=null&&s.threadData?{...s,threadData:{...s.threadData,admin:i}}:s),o.setQueryData(["subthreadSubscribers",r],s=>(Array.isArray(s),s)),console.log(`Admin transferred from ${a} to ${i}`)},[o,r]),j=l.useCallback(p=>{const{subthread_id:a,new_admin:i}=p;a===r&&(o.setQueryData(["thread",r],s=>s!=null&&s.threadData?{...s,threadData:{...s.threadData,admin:i}}:s),console.log(`Admin rights transferred to ${i}`))},[o,r]),b=l.useCallback(p=>{const{subthread_id:a,old_admin:i}=p;a===r&&(o.setQueryData(["thread",r],s=>s!=null&&s.threadData?{...s,threadData:{...s.threadData,admin:d==null?void 0:d.username}}:s),console.log(`You are now admin of this subthread (transferred from ${i})`))},[o,r,d==null?void 0:d.username]);l.useEffect(()=>{if(n)return r&&n.emit("join",{room:r}),d!=null&&d.username&&n.emit("join",{room:`user_${d.username}`}),n.on("user_banned",k),n.on("user_unbanned",f),n.on("you_were_banned",S),n.on("you_were_unbanned",A),n.on("mod_added",N),n.on("mod_removed",h),n.on("you_were_demoted",m),n.on("admin_transferred",g),n.on("you_lost_admin",j),n.on("you_became_admin",b),()=>{r&&n.emit("leave",{room:r}),d!=null&&d.username&&n.emit("leave",{room:`user_${d.username}`}),n.off("user_banned",k),n.off("user_unbanned",f),n.off("you_were_banned",S),n.off("you_were_unbanned",A),n.off("mod_added",N),n.off("mod_removed",h),n.off("you_were_demoted",m),n.off("admin_transferred",g),n.off("you_lost_admin",j),n.off("you_became_admin",b)}},[n,r,d==null?void 0:d.username,k,f,S,A,N,h,m,g,j,b]);const t=l.useCallback((p,a,i)=>{n&&n.emit("user_banned",{username:p,subthread_id:r,banned_by:a,reason:i})},[n,r]),T=l.useCallback((p,a)=>{n&&n.emit("user_unbanned",{username:p,subthread_id:r,unbanned_by:a})},[n,r]);return{emitUserBan:t,emitUserUnban:T}}te.propTypes={threadId:E.string.isRequired,onClose:E.func};function te({threadId:r,onClose:n}){var C,Q,R;const{t:d}=W(),o=I(),[w,k]=l.useState("user-viewer"),[f,S]=l.useState(""),[A,N]=l.useState(null),[h,m]=l.useState(""),[g,j]=l.useState(!1);ee(r);const{data:b,isLoading:t,refetch:T}=Y({queryKey:["user-management",r],queryFn:async()=>(await M.get(`/api/thread/${r}/user-management`)).data}),{data:p,isFetching:a}=Y({queryKey:["search/user",f],queryFn:async({signal:c})=>await M.get(`/api/user/search/${f}`,{signal:c}).then(U=>U.data),enabled:!!(f&&f.length>3)}),{data:i,isLoading:s,error:x}=Y({queryKey:["subthreadSubscribers",r],queryFn:async()=>(await M.get(`/api/thread/${r}/subscribers`)).data,enabled:w==="user-viewer"}),$=q({mutationFn:async({username:c,reason:U})=>await M.post(`/api/thread/${r}/ban/${c}`,{reason:U}),onSuccess:()=>{T(),j(!1),m(""),N(null),F.success(d("alerts.userBannedSuccessfully"))},onError:c=>{var U,O;F.error(((O=(U=c.response)==null?void 0:U.data)==null?void 0:O.message)||d("alerts.failedToBanUser"))}}),B=q({mutationFn:async c=>await M.post(`/api/thread/${r}/unban/${c}`),onSuccess:()=>{T(),F.success(d("alerts.userUnbannedSuccessfully"))},onError:c=>{var U,O;F.error(((O=(U=c.response)==null?void 0:U.data)==null?void 0:O.message)||d("alerts.failedToUnbanUser"))}}),{data:L,mutate:y}=q({mutationFn:async c=>(await M.get(`/api/thread/${r}/user/${c}/posts`)).data}),v=c=>{N(c),j(!0)},u=()=>{A&&$.mutate({username:A,reason:h||d("alerts.unspecificBanReason")})},_=async c=>{await o(d("alerts.unbanUserConfirm",{username:c}))&&B.mutate(c)};return t?e.jsx("div",{className:"w-5/6 h-5/6 bg-theme-less-white dark:bg-theme-dark-bg rounded-md flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-theme-blue border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-theme-dark-text",children:"Loading users..."})]})}):e.jsxs("div",{className:"w-5/6 h-5/6 bg-theme-less-white dark:bg-theme-dark-bg rounded-md overflow-hidden dark:text-theme-dark-text",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-theme-border-light dark:border-theme-dark-border",children:[e.jsx("h1",{className:"text-2xl font-semibold text-theme-blue",children:"User Management"}),n&&e.jsx("button",{onClick:n,className:"text-theme-text-secondary hover:text-theme-text-primary dark:text-theme-dark-text dark:hover:text-theme-dark-text",children:e.jsx(P,{type:"close",className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex border-b border-theme-border-light dark:border-theme-dark-border",children:[e.jsxs("button",{onClick:()=>k("user-viewer"),className:`px-4 py-2 font-medium ${w==="user-viewer"?"text-theme-blue border-b-2 border-theme-blue":"text-theme-text-secondary hover:text-theme-blue dark:text-theme-dark-text dark:hover:text-theme-blue"}`,children:["User Viewer (",((C=b==null?void 0:b.subscribers)==null?void 0:C.length)||0,")"]}),e.jsxs("button",{onClick:()=>k("banned"),className:`px-4 py-2 font-medium ${w==="banned"?"text-theme-blue border-b-2 border-theme-blue":"text-theme-text-secondary hover:text-theme-blue dark:text-theme-dark-text dark:hover:text-theme-blue"}`,children:["Banned Users (",((Q=b==null?void 0:b.banned_users)==null?void 0:Q.length)||0,")"]}),e.jsx("button",{onClick:()=>k("search"),className:`px-4 py-2 font-medium ${w==="search"?"text-theme-blue border-b-2 border-theme-blue":"text-theme-text-secondary hover:text-theme-blue dark:text-theme-dark-text dark:hover:text-theme-blue"}`,children:"Search & Ban"})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4",children:[w==="user-viewer"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Users Joined This Subthread"}),s&&e.jsx("p",{children:"Loading..."}),x&&e.jsx("p",{className:"text-theme-error",children:"Unable to load the list of users at this time. Please try again later."}),!s&&i&&Array.isArray(i)&&i.length===0&&e.jsx("p",{children:"No users have joined this subthread yet."}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:i&&i.map(c=>e.jsx("div",{className:"p-3 bg-theme-light-gray2 dark:bg-theme-dark-card rounded-md border-b border-theme-border-light dark:border-theme-dark-border",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[c.avatar&&e.jsx("img",{src:c.avatar,alt:c.username,className:"w-8 h-8 rounded-md"}),e.jsx("span",{className:"font-medium",children:c.username})]})},c.id))})]}),w==="banned"&&e.jsx("div",{className:"space-y-2",children:(R=b==null?void 0:b.banned_users)==null?void 0:R.map(c=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-theme-error-light rounded-md border border-theme-error-border",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[c.avatar&&e.jsx("img",{src:c.avatar,alt:c.username,className:"w-8 h-8 rounded-md"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:c.username}),e.jsxs("div",{className:"text-sm text-theme-text-secondary",children:["Reason: ",c.reason]}),e.jsxs("div",{className:"text-xs text-theme-text-muted",children:["Banned: ",new Date(c.banned_at).toLocaleDateString()]})]})]}),e.jsx("button",{onClick:()=>_(c.username),className:"text-theme-success hover:underline text-sm",children:"Unban"})]},c.username))}),w==="search"&&e.jsxs("div",{children:[e.jsx("input",{type:"text",value:f,onChange:c=>S(c.target.value),className:"w-full p-2 border-2 rounded-md mb-4 bg-theme-less-white dark:bg-theme-dark-card dark:text-theme-dark-text border-theme-border-light dark:border-theme-dark-border",placeholder:"Search username to ban (even if not joined)"}),a?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(ce,{text:d("common.searching")})}):p&&e.jsx("div",{className:"space-y-2",children:p.map(c=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-theme-light-gray2 dark:bg-theme-dark-card rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[c.avatar&&e.jsx("img",{src:c.avatar,alt:c.username,className:"w-8 h-8 rounded-md"}),e.jsx("span",{className:"font-medium",children:c.username})]}),e.jsx("button",{onClick:()=>v(c.username),className:"text-theme-error hover:underline text-sm",children:"Ban User"})]},c.username))})]})]}),g&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-theme-less-white dark:bg-theme-dark-card p-6 rounded-lg max-w-md w-full mx-4",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 text-theme-text-primary dark:text-theme-dark-text",children:["Ban User: ",A]}),e.jsx("textarea",{value:h,onChange:c=>m(c.target.value),className:"w-full p-2 border border-theme-border-light dark:border-theme-dark-border rounded-md mb-4 text-theme-text-primary dark:text-theme-dark-text bg-theme-less-white dark:bg-theme-dark-bg",rows:"3",placeholder:"Enter ban reason (optional)"}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:()=>j(!1),className:"px-4 py-2 text-theme-text-secondary hover:text-theme-text-primary dark:text-theme-dark-text dark:hover:text-theme-dark-text",children:"Cancel"}),e.jsx("button",{onClick:u,className:"px-4 py-2 bg-theme-error text-white rounded hover:bg-theme-error-dark",children:"Ban User"})]})]})}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Posts by ",L.username," (",L.total_posts," posts, ",L.total_comments," comments)"]}),e.jsx("button",{onClick:()=>y(null),className:"text-theme-text-secondary hover:text-theme-text-primary",children:e.jsx(P,{type:"close",className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Posts:"}),(L.posts||[]).map(c=>e.jsxs("div",{className:"p-3 bg-theme-bg-secondary rounded mb-2",children:[e.jsx("div",{className:"font-medium",children:c.title}),e.jsx("div",{className:"text-sm text-theme-text-secondary",children:c.content}),e.jsx("div",{className:"text-xs text-theme-text-muted",children:new Date(c.created_at).toLocaleDateString()})]},c.id))]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Comments:"}),(L.comments||[]).map(c=>e.jsxs("div",{className:"p-3 bg-theme-bg-secondary rounded mb-2",children:[e.jsx("div",{className:"text-sm text-theme-text-secondary",children:c.content}),e.jsx("div",{className:"text-xs text-theme-text-muted",children:new Date(c.created_at).toLocaleDateString()})]},c.id))]})]})]})})]})}function de(r,n){const{socket:d}=V(),o=J(),w=l.useCallback(N=>{const{subthreadId:h}=N;h===r&&(o.setQueryData(["thread",n],m=>m!=null&&m.threadData?{...m,threadData:{...m.threadData,subscriberCount:(m.threadData.subscriberCount||0)+1}}:m),o.setQueryData(["subthreadSubscribers",r],m=>(Array.isArray(m),m)))},[o,r,n]),k=l.useCallback(N=>{const{subthreadId:h}=N;h===r&&(o.setQueryData(["thread",n],m=>m!=null&&m.threadData?{...m,threadData:{...m.threadData,subscriberCount:Math.max(0,(m.threadData.subscriberCount||0)-1)}}:m),o.setQueryData(["subthreadSubscribers",r],m=>(Array.isArray(m),m)))},[o,r,n]),f=l.useCallback(N=>{const{id:h,name:m,description:g,logo:j}=N,b={id:h,name:m,description:g,logo:j};o.setQueryData(["subthreads"],t=>Array.isArray(t)?[b,...t]:[b])},[o]),S=l.useCallback(N=>{const{id:h,updated_fields:m}=N;o.setQueryData(["subthreads"],g=>Array.isArray(g)?g.map(j=>j.id===h?{...j,...m}:j):g)},[o]);return l.useEffect(()=>{if(d)return r&&d.emit("join",{room:r}),d.on("subthread_joined",w),d.on("subthread_left",k),d.on("subthread_created",f),d.on("subthread_updated",S),()=>{r&&d.emit("leave",{room:r}),d.off("subthread_joined",w),d.off("subthread_left",k),d.off("subthread_created",f),d.off("subthread_updated",S)}},[d,r,w,k,f,S]),{emitSubthreadUpdate:l.useCallback((N,h)=>{d&&d.emit("subthread_updated",{subthread_id:r,updated_fields:N,updated_by:h})},[d,r])}}function le(r={}){const{socket:n}=V(),d=J(),[o,w]=l.useState(0),[k,f]=l.useState([]),[S,A]=l.useState([]),[N,h]=l.useState(null),[m,g]=l.useState([]),j=l.useRef(new Map),{subthreadId:b,enableLiveUserCount:t=!0,enableUserActivity:T=!0,enableSystemStatus:p=!0,activityTimeout:a=3e4,maxActivityItems:i=50}=r,s=l.useCallback(_=>{const{user_count:C,active_users:Q}=_;w(C),f(Q||[])},[]),x=l.useCallback(_=>{const{username:C,activity_type:Q,timestamp:R}=_;A(c=>[{username:C,activity_type:Q,timestamp:R||new Date().toISOString(),id:Date.now()+Math.random()},...c].slice(0,i)),j.current.has(C)&&clearTimeout(j.current.get(C)),j.current.set(C,setTimeout(()=>{A(c=>c.filter(U=>U.username!==C)),j.current.delete(C)},a))},[i]),$=l.useCallback(_=>{const{status_type:C,message:Q,severity:R,timestamp:c}=_;h({type:C,message:Q,severity:R,timestamp:c||new Date().toISOString()})},[]),B=l.useCallback(_=>{const{metrics_type:C,value:Q,threshold:R,timestamp:c}=_;g(U=>[{type:C,value:Q,threshold:R,timestamp:c||new Date().toISOString(),id:Date.now()+Math.random()},...U].slice(0,10))},[]),L=l.useCallback(_=>{const{stats_type:C,new_value:Q,updated_by:R}=_;b&&d.setQueryData(["thread",b],c=>{if(!(c!=null&&c.threadData))return c;const U={...c.threadData};switch(C){case"posts_count":U.PostsCount=Math.max(0,(U.PostsCount||0)+Q);break;case"subscriber_count":U.subscriberCount=Math.max(0,(U.subscriberCount||0)+Q);break;case"active_users":U.activeUsers=Q;break}return{...c,threadData:U}})},[d,b]),y=l.useCallback((_,C=null)=>{n&&n.emit("user_activity",{activity_type:_,subthread_id:b,post_id:C,timestamp:new Date().toISOString()})},[n,b]),v=l.useCallback((_,C)=>{n&&n.emit("post_shared",{post_id:_,share_platform:C,subthread_id:b})},[n,b]),u=l.useCallback((_,C,Q,R)=>{n&&n.emit("mention",{mentioned_user:_,post_id:C,comment_id:Q,content:R})},[n]);return l.useEffect(()=>{if(N){const _=setTimeout(()=>{h(null)},5e3);return()=>clearTimeout(_)}},[N]),l.useEffect(()=>{if(m&&Array.isArray(m)&&m.length>0){const _=setTimeout(()=>{g(C=>C.slice(1))},1e4);return()=>clearTimeout(_)}},[m]),l.useEffect(()=>{if(n)return b&&n.emit("join",{room:b}),t&&n.on("live_user_count_updated",s),T&&n.on("user_activity",x),p&&(n.on("system_status_update",$),n.on("performance_alert",B)),n.on("subthread_stats_updated",L),()=>{b&&n.emit("leave",{room:b}),n.off("live_user_count_updated",s),n.off("user_activity",x),n.off("system_status_update",$),n.off("performance_alert",B),n.off("subthread_stats_updated",L),j.current.forEach(_=>clearTimeout(_)),j.current.clear()}},[n,b,t,T,p,s,x,$,B,L]),{liveUserCount:o,activeUsers:k,userActivity:S,systemStatus:N,performanceAlerts:m,emitUserActivity:y,emitPostShare:v,emitMention:u,clearSystemStatus:()=>h(null),clearPerformanceAlerts:()=>g([]),clearUserActivity:()=>A([])}}se.propTypes={subthreadId:E.string,showUserCount:E.bool,showActivity:E.bool,showSystemStatus:E.bool,maxActivityItems:E.number,className:E.string};function se({subthreadId:r,showUserCount:n=!0,showActivity:d=!0,showSystemStatus:o=!0,maxActivityItems:w=5,className:k=""}){const{t:f}=W(),[S,A]=l.useState(!1),{liveUserCount:N,activeUsers:h,userActivity:m,systemStatus:g,performanceAlerts:j,emitUserActivity:b}=le({subthreadId:r,enableLiveUserCount:n,enableUserActivity:d,enableSystemStatus:o,maxActivityItems:w})||{liveUserCount:0,activeUsers:[],userActivity:[],systemStatus:null,performanceAlerts:[],emitUserActivity:()=>{}};l.useEffect(()=>{r&&b("browsing")},[r,b]);const t=i=>{switch(i){case"posting":return"ðŸ“";case"commenting":return"ðŸ’¬";case"voting":return"ðŸ‘";case"browsing":return"ðŸ‘€";case"joining":return"âž•";case"leaving":return"âž–";default:return"ðŸ‘¤"}},T=i=>{switch(i){case"posting":return f("activity.posting");case"commenting":return f("activity.commenting");case"voting":return f("activity.voting");case"browsing":return f("activity.browsing");case"joining":return f("activity.joining");case"leaving":return f("activity.leaving");default:return f("activity.unknown")}},p=i=>{switch(i){case"error":return"text-red-500 bg-red-50 border-red-200";case"warning":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"info":return"text-blue-600 bg-blue-50 border-blue-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},a=i=>{switch(i){case"maintenance":return"ðŸ”§";case"performance":return"âš¡";case"error":return"âš ï¸";default:return"â„¹ï¸"}};return!n&&!d&&!o?null:e.jsxs("div",{className:`live-activity-indicator ${k}`,children:[n&&N>0&&e.jsxs(K.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300 mb-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:f("live.users",{count:N})}),h&&Array.isArray(h)&&h.length>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:["(",h.slice(0,3).join(", "),((h==null?void 0:h.length)||0)>3?"...":"",")"]})]}),e.jsx(z,{children:o&&g&&e.jsx(K.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:`p-2 rounded-lg border text-sm mb-2 ${p(g.severity)}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:a(g.type)}),e.jsx("span",{className:"font-medium",children:g.message})]})})}),e.jsx(z,{children:o&&j&&Array.isArray(j)&&j.length>0&&e.jsx(K.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"p-2 rounded-lg border border-orange-200 bg-orange-50 text-orange-700 text-sm mb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"âš¡"}),e.jsx("span",{children:f("performance.alert")})]})})}),d&&m&&Array.isArray(m)&&m.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("button",{onClick:()=>A(!S),className:"text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors",children:[f(S?"activity.hide":"activity.show")," (",(m==null?void 0:m.length)||0,")"]}),e.jsx(z,{children:S&&e.jsx(K.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-1",children:m.slice(0,w).map(i=>e.jsxs(K.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},className:"flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400",children:[e.jsx("span",{children:t(i.activity_type)}),e.jsx("span",{className:"font-medium",children:i.username}),e.jsx("span",{children:T(i.activity_type)}),e.jsx("span",{className:"text-gray-400",children:new Date(i.timestamp).toLocaleTimeString()})]},i.id))})})]})]})}function ye(){const{t:r}=W(),n=Z(),{isAuthenticated:d,user:o}=V(),w=I(),[k,f]=l.useState(null),[S,A]=l.useState(!1),N=l.useRef(null),h=J(),m=re(),g=m.threadName;de(g,m.threadName),ee(g);const{data:j,isFetching:b}=Y({queryKey:["thread",m.threadName],queryFn:async()=>{try{return await M.get(`/api/threads/${m.threadName}`).then(y=>y.data)}catch(y){if(oe(y,n))return null;throw y}}});l.useEffect(()=>(document.title="t/"+m.threadName,()=>{document.title="yuuzone"}),[m.threadName]);const t=j==null?void 0:j.threadData,T=t==null?void 0:t.currentUserRole,p=(t==null?void 0:t.currentUserRoles)||[],a=p.includes("admin")||T==="admin",i=p.includes("mod")||T==="mod",{connected:s,socket:x}=ne(t==null?void 0:t.name);l.useEffect(()=>{if(s)return x.on("new_post",()=>{h.setQueryData(["thread",m.threadName],y=>y&&{...y,threadData:{...y.threadData,PostsCount:y.threadData.PostsCount+1}}),h.invalidateQueries(["posts/thread",t==null?void 0:t.id])}),x.on("subthread_joined",({subthreadId:y})=>{(t==null?void 0:t.id)===y&&h.setQueryData(["thread",m.threadName],v=>v&&{...v,threadData:{...v.threadData,subscriberCount:v.threadData.subscriberCount+1}})}),x.on("subthread_left",({subthreadId:y})=>{(t==null?void 0:t.id)===y&&h.setQueryData(["thread",m.threadName],v=>v&&{...v,threadData:{...v.threadData,subscriberCount:v.threadData.subscriberCount-1}})}),x.on("mod_added",({thread_id:y,username:v})=>{(t==null?void 0:t.id)===y&&h.setQueryData(["thread",m.threadName],u=>{if(!u)return u;const _=u.threadData.modList?[...u.threadData.modList,v]:[v];return{...u,threadData:{...u.threadData,modList:_}}})}),x.on("mod_removed",({thread_id:y,username:v})=>{(t==null?void 0:t.id)===y&&h.setQueryData(["thread",m.threadName],u=>{if(!u)return u;const _=u.threadData.modList?u.threadData.modList.filter(C=>C!==v):[];return{...u,threadData:{...u.threadData,modList:_}}})}),()=>{x.off("new_post"),x.off("subthread_joined"),x.off("subthread_left"),x.off("mod_added"),x.off("mod_removed")}},[s,x,h,m.threadName,t==null?void 0:t.id]);const{mutate:$}=q({mutationFn:async y=>{y?M.delete(`/api/threads/subscription/${t.id}`).then(()=>h.setQueryData(["thread",m.threadName],v=>({threadData:{...v.threadData,has_subscribed:!1}}))):M.post(`/api/threads/subscription/${t.id}`).then(()=>h.setQueryData(["thread",m.threadName],v=>({threadData:{...v.threadData,has_subscribed:!0}})))}}),B=q({mutationFn:async()=>await M.delete(`/api/thread/${t.id}`),onSuccess:()=>{n("/")},onError:y=>{var v,u;F.error(((u=(v=y.response)==null?void 0:v.data)==null?void 0:u.message)||r("alerts.unableToDeleteSubthread"))}});if(t!=null&&t.is_banned)return n(`/banned/${t.id}`),null;function L(y){switch(y){case"more":break;case"edit":f(e.jsx(me,{ogInfo:t,edit:!0,setShowModal:f}));break;case"manage-mods":{const v=(t.modList||[]).map(u=>typeof u=="string"?{username:u}:u);f(e.jsx(D,{mods:v,threadId:t.id}));break}case"user-management":f(e.jsx(te,{threadId:t.id,onClose:()=>f(null)}));break;case"delete":{w(r("alerts.deleteSubthreadConfirm"))&&B.mutate();break}case"logo":f(e.jsx("img",{src:t==null?void 0:t.logo,className:"object-cover w-11/12 max-h-5/6 md:w-max md:max-h-screen",alt:""}));break;default:n(`/u/${y}`)}N.current.value="more"}return e.jsxs("div",{className:"flex flex-col flex-1 items-center w-full bg-theme-light-gray2 dark:bg-theme-dark-bg dark:text-theme-dark-text",children:[e.jsxs("div",{className:"flex flex-col p-5 space-y-1 w-full bg-theme-less-white dark:bg-theme-dark-card rounded-md md:pb-3 md:space-y-3",children:[b?e.jsx(X,{forPosts:!0}):e.jsxs("div",{className:`flex p-2 flex-col md:flex-row items-center rounded-md md:rounded-md bg-theme-light-gray2 dark:bg-theme-dark-bg ${!(t!=null&&t.logo)&&"py-5"}`,children:[(t==null?void 0:t.logo)&&e.jsx("img",{src:t==null?void 0:t.logo,className:"object-cover w-32 h-32 rounded-md cursor-pointer md:w-36 md:h-36",alt:"",onClick:()=>L("logo")}),e.jsxs("div",{className:"flex flex-col flex-1 justify-around items-center p-2 space-y-1",children:[e.jsx("div",{className:"flex items-center space-x-5",children:e.jsx("h1",{className:"text-xl font-semibold text-theme-text-primary dark:text-theme-dark-text",children:t==null?void 0:t.name})}),e.jsxs("p",{className:"text-lg text-theme-text-secondary dark:text-theme-dark-text",children:["Since: ",new Date(t==null?void 0:t.created_at).toDateString()]}),(t==null?void 0:t.description)&&e.jsxs("p",{className:`text-center py-4 md:py-2 text-sm dark:text-theme-dark-text ${((t==null?void 0:t.description)||"").length>90&&"text-lg"}`,children:[t==null?void 0:t.description,((t==null?void 0:t.description)||"").length>90&&"..."]}),e.jsxs("div",{className:"flex justify-between mt-2 space-x-7 w-full md:w-11/12",children:[e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:[t==null?void 0:t.subscriberCount," subscribers"]}),e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:[t==null?void 0:t.PostsCount," posts"]}),e.jsxs("p",{className:"text-sm text-theme-text-secondary dark:text-theme-dark-text",children:[t==null?void 0:t.CommentsCount," comments"]})]}),e.jsx(se,{subthreadId:g,showUserCount:!0,showActivity:!0,showSystemStatus:!0,maxActivityItems:3,className:"mt-3"})]})]}),e.jsxs("div",{className:"flex flex-col justify-around space-y-3 md:space-x-10 md:flex-row md:space-y-0",children:[e.jsx("div",{className:"flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-4",children:d&&e.jsx("button",{className:`px-32 py-2 text-white rounded-md active:scale-90 ${t!=null&&t.has_subscribed?"bg-blue-400":"bg-theme-blue-coral"} dark:bg-theme-blue-coral`,onClick:()=>$(t==null?void 0:t.has_subscribed),disabled:(t==null?void 0:t.created_by)===o.id&&(t==null?void 0:t.modList)&&Array.isArray(t.modList)&&t.modList.length>0,title:(t==null?void 0:t.created_by)===o.id&&(t!=null&&t.modList)&&Array.isArray(t.modList)&&t.modList.length>0?r("subthreads.transferOwnershipBeforeLeaving"):"",children:t!=null&&t.has_subscribed?r("subthreads.leave"):r("subthreads.join")})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("select",{ref:N,defaultValue:"more",onChange:y=>L(y.target.value),name:"mods",id:"mods",className:"px-3 py-1 text-center text-2xl font-extrabold rounded-md md:block bg-transparent appearance-none cursor-pointer border-none outline-none dark:text-theme-text-primary",style:{backgroundImage:"none"},children:[e.jsx("option",{value:"more",className:"text-base font-normal",style:{display:"none"},children:"â‹¯"}),d&&(a||o.id===(t==null?void 0:t.created_by))&&e.jsxs("optgroup",{label:r("subthreads.adminOptions"),className:"text-lg font-bold",children:[e.jsx("option",{value:"edit",className:"text-lg font-normal",children:r("subthreads.editSubthread")}),e.jsx("option",{value:"manage-mods",className:"text-lg font-normal",children:r("subthreads.manageMods")}),e.jsx("option",{value:"user-management",className:"text-lg font-normal",children:r("moderation.userManagement")}),e.jsx("option",{value:"delete",className:"text-lg font-normal",children:r("subthreads.deleteSubthread")})]}),d&&i&&!a&&o.id!==(t==null?void 0:t.created_by)&&e.jsx("optgroup",{label:r("moderation.moderatorOptions"),className:"text-lg font-bold",children:e.jsx("option",{value:"user-management",className:"text-lg font-normal",children:r("moderation.userManagement")})}),(()=>{if(!t)return null;const y=t.created_by_username?[t.created_by_username]:[],v=t.modList.filter(u=>!y.includes(typeof u=="string"?u:u.username||u));return e.jsxs(e.Fragment,{children:[e.jsx("optgroup",{label:r("moderation.subthreadAdmin"),className:"text-lg font-bold",children:y&&Array.isArray(y)&&y.length>0?y.map(u=>e.jsx("option",{value:u,className:"text-lg font-normal",children:u},u)):e.jsx("option",{value:"abandoned",className:"text-lg font-normal text-theme-text-muted dark:text-theme-text-secondary",children:r("moderation.abandoned")})}),e.jsx("optgroup",{label:r("moderation.subthreadMods"),className:"text-lg font-bold",children:v.map(u=>e.jsx("option",{value:typeof u=="string"?u:u.username||u,className:"text-lg font-normal",children:typeof u=="string"?u:u.username||u},typeof u=="string"?u:u.username||u))})]})})()]}),d&&(a||o.id===(t==null?void 0:t.created_by)||i)&&e.jsxs(e.Fragment,{children:[a&&e.jsx(P,{type:"crown-admin",external:!0,className:"w-8 h-8 ml-2 text-theme-yellow-crown"}),i&&!a&&e.jsx(P,{type:"wrench-mod",external:!0,className:"w-5 h-5 ml-2 text-theme-wine-wrench"})]})]})]})]}),e.jsx(ae,{apiQueryKey:t==null?void 0:t.name,linkUrl:`posts/thread/${t==null?void 0:t.id}`,enabled:t!==void 0}),e.jsxs(z,{children:[k&&e.jsx(G,{setShowModal:f,children:k}),S&&e.jsx(G,{setShowModal:A,children:e.jsx(ie,{setShowModal:A,threadInfo:{thread_id:t==null?void 0:t.id,thread_name:t==null?void 0:t.name}})})]})]})}export{ye as SubThread,ye as default};
