import{A as Q,u as q,r as m,i as E,c as P,a as $,f as M,d as S,j as s,v as D,S as I,b as B,U as K,I as R,y as T,M as F,Q as U}from"./vendor_react_core-BgINF0UJ.js";import{a as v}from"./vendor_axios-NIGUFBhG.js";import{Chat as O}from"./Inbox-PvTbx31Y.js";import"./vendor_other-DbdEjI2z.js";import"./vendor_socket_io_client-DCrnUc9D.js";import"./index-CW2uvCmf.js";function z(){const{socket:c,user:t}=Q(),u=q(),[l,x]=m.useState([]),[g,b]=m.useState(0),h=m.useCallback(a=>{const{type:r,title:i,message:n,action_url:d,sender:y,timestamp:f}=a,p={id:Date.now()+Math.random(),type:r,title:i,message:n,action_url:d,sender:y,timestamp:f||new Date().toISOString(),read:!1};x(o=>[p,...o.slice(0,49)]),b(o=>o+1),Notification.permission==="granted"&&new Notification(i,{body:n,icon:"/favicon.ico",tag:p.id}),u.setQueryData(["notifications"],o=>o?[p,...o.slice(0,49)]:[p]),console.log("New notification:",p)},[u]),j=m.useCallback(a=>{const{username:r,updated_fields:i,avatar_url:n}=a;[["search/user"],["subthreadSubscribers"],["comments"],["posts"]].forEach(y=>{u.setQueryData(y,f=>{if(!f)return f;const p=o=>{var A;return o.username===r||((A=o.user)==null?void 0:A.username)===r?{...o,...i,avatar:n||o.avatar,user:o.user?{...o.user,...i,avatar:n||o.user.avatar}:o.user}:o};return Array.isArray(f)?f.map(p):f.pages?{...f,pages:f.pages.map(o=>Array.isArray(o)?o.map(p):o)}:f})})},[u]),k=m.useCallback(a=>{const{username:r,status:i}=a;u.setQueryData(["userStatus",r],i),console.log(`User ${r} is now ${i}`)},[u]),C=m.useCallback(async()=>"Notification"in window&&Notification.permission==="default"?await Notification.requestPermission()==="granted":Notification.permission==="granted",[]),e=m.useCallback(a=>{x(r=>r.map(i=>i.id===a?{...i,read:!0}:i)),b(r=>Math.max(0,r-1)),u.setQueryData(["notifications"],r=>r&&r.map(i=>i.id===a?{...i,read:!0}:i))},[u]),_=m.useCallback(()=>{x(a=>a.map(r=>({...r,read:!0}))),b(0),u.setQueryData(["notifications"],a=>a&&a.map(r=>({...r,read:!0})))},[u]),w=m.useCallback(()=>{x([]),b(0),u.setQueryData(["notifications"],[])},[u]);m.useEffect(()=>{if(!c||!(t!=null&&t.username))return;const a=setTimeout(()=>{c.emit("join",{room:`user_${t.username}`})},500);return c.on("notification",h),c.on("profile_updated",j),c.on("user_status_changed",k),()=>{clearTimeout(a),c.emit("leave",{room:`user_${t.username}`}),c.off("notification",h),c.off("profile_updated",j),c.off("user_status_changed",k)}},[c,t==null?void 0:t.username,h,j,k]);const N=m.useCallback((a,r,i,n,d=null)=>{c&&c.emit("notification",{recipient_username:a,type:r,title:i,message:n,action_url:d,sender:t==null?void 0:t.username,timestamp:new Date().toISOString()})},[c,t==null?void 0:t.username]);return{notifications:l,unreadCount:g,markAsRead:e,markAllAsRead:_,clearAllNotifications:w,requestNotificationPermission:C,sendNotification:N}}function X(){const{user:c}=Q(),{username:t}=E(),u=P(),{t:l}=$();z();const[x,g]=m.useState(!1),[b,h]=m.useState(!1),[j,k]=m.useState(!1),C=m.useRef(null);M(C,()=>h(!1));const{data:e,isFetching:_}=S({queryKey:["user",t],queryFn:async()=>await v.get(`/api/user/${t}`).then(n=>n.data)}),{data:w}=S({queryKey:["blockedUsers"],queryFn:async()=>await v.get("/api/user/blocked").then(n=>n.data),enabled:c&&c.username!==t}),{data:N}=S({queryKey:["isBlockedBy",t],queryFn:async()=>await v.get(`/api/user/blocked-by/${t}`).then(n=>n.data.blocked),enabled:c&&c.username!==t});m.useEffect(()=>{if(w&&e){const n=w.some(d=>d.username===e.username);k(n)}},[w,e]),m.useEffect(()=>{x==="message"&&g(s.jsx(O,{sender:e,setCurChat:g,newChat:!0}))},[x,e]);const a=()=>{u("/inbox",{state:{startChatWith:e}}),h(!1)},r=async()=>{var n,d;try{await v.post(`/api/user/block/${e.username}`),k(!0),h(!1),U.success(l("alerts.userBlocked",{username:e.username}))}catch(y){U.error(((d=(n=y.response)==null?void 0:n.data)==null?void 0:d.message)||l("alerts.failedToBlockUser"))}},i=async()=>{var n,d;try{await v.post(`/api/user/unblock/${e.username}`),k(!1),h(!1),U.success(l("alerts.userUnblocked",{username:e.username}))}catch(y){U.error(((d=(n=y.response)==null?void 0:n.data)==null?void 0:d.message)||l("alerts.failedToUnblockUser"))}};return m.useEffect(()=>(document.title="u/"+t,()=>document.title="yuuzone"),[t]),s.jsxs("div",{className:"flex flex-col flex-1 items-center w-full bg-theme-light-gray2 dark:bg-theme-dark-bg dark:text-theme-dark-text",children:[_?s.jsx(D,{forPosts:!0}):N?s.jsx("div",{className:"flex flex-col items-center justify-center w-full min-h-96 bg-theme-less-white dark:bg-theme-dark-card rounded-md p-8 m-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("h1",{className:"text-3xl font-bold text-theme-text-primary mb-4",children:l("user.blockedByUser",{username:t})}),s.jsx("p",{className:"text-lg text-theme-text-secondary",children:l("user.blockedByUserDescription")})]})}):s.jsx("div",{className:"flex flex-col items-center w-full bg-theme-light-gray2 dark:bg-theme-dark-bg",children:s.jsxs("div",{className:"flex flex-col p-2 w-full bg-theme-less-white dark:bg-theme-dark-card rounded-md md:p-5 relative",children:[c.username!==(e==null?void 0:e.username)&&!N&&s.jsxs("div",{className:"absolute top-4 right-4 z-10",ref:C,children:[s.jsx("button",{onClick:()=>h(!b),className:"flex items-center justify-center w-8 h-8 text-theme-text-primary",title:"More options",children:s.jsx(I,{type:"more",className:"w-6 h-6"})}),b&&s.jsx("div",{className:"absolute top-full right-0 mt-1 w-40 bg-white dark:bg-theme-dark-card rounded-md shadow-lg border border-gray-200 dark:border-theme-dark-border z-50 dark:text-theme-dark-text",children:s.jsxs("div",{className:"py-1",children:[s.jsx("button",{onClick:a,className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-theme-dark-text hover:bg-gray-100 dark:hover:bg-theme-dark-bg",children:l("user.message")}),s.jsx("button",{onClick:j?i:r,className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-theme-dark-text hover:bg-gray-100 dark:hover:bg-theme-dark-bg",children:l(j?"user.unblock":"user.block")})]})})]}),s.jsxs("div",{className:"flex flex-col flex-1 justify-between items-center p-2 w-full rounded-md md:flex-row md:rounded-md bg-theme-light-gray2 dark:bg-theme-dark-card dark:text-theme-dark-text",children:[s.jsx("img",{src:e.avatar||B,className:"object-cover w-24 h-24 bg-theme-less-white rounded-md cursor-pointer md:w-36 md:h-36",alt:"",onClick:()=>g(s.jsx("img",{src:e.avatar||B,className:"object-cover w-11/12 max-h-5/6 md:w-max md:max-h-screen",alt:""}))}),s.jsxs("div",{className:"flex flex-col flex-1 items-center w-full md:p-2",children:[s.jsxs("h1",{className:"mt-2 text-lg font-semibold md:m-0",children:["u/",e.username]}),s.jsx("div",{className:"mt-2 mb-2",children:s.jsx(K,{subscriptionTypes:(e==null?void 0:e.subscription_types)||[],className:"px-3 py-1 rounded-lg text-xs font-bold"})}),s.jsx("p",{className:"my-4 w-11/12 text-sm text-center md:my-2 md:text-base",children:e==null?void 0:e.bio}),s.jsxs("div",{className:"flex justify-between items-center w-full md:w-11/12",children:[s.jsxs("p",{className:"text-xs md:text-sm",children:[l("user.karma"),": ",e==null?void 0:e.karma.user_karma]}),s.jsxs("p",{className:"text-xs md:text-sm",children:[l("user.cakeDayOn"),": ",new Date(e==null?void 0:e.registrationDate).toDateString()]})]})]})]}),s.jsxs("div",{className:"flex flex-col my-2 text-sm md:text-sm",children:[s.jsxs("div",{className:"flex justify-between space-x-2",children:[s.jsxs("p",{className:"",children:[l("user.totalPosts"),": ",e==null?void 0:e.karma.posts_count]}),s.jsxs("p",{className:"",children:[l("user.postsKarma"),": ",e==null?void 0:e.karma.posts_karma]})]}),s.jsxs("div",{className:"flex justify-between space-x-2",children:[s.jsxs("p",{className:"",children:[l("user.totalComments"),": ",e==null?void 0:e.karma.comments_count]}),s.jsxs("p",{className:"",children:[l("user.commentsKarma"),": ",e==null?void 0:e.karma.comments_karma]})]})]})]})}),(e==null?void 0:e.deleted)&&!_&&s.jsx("div",{className:"flex flex-col items-center justify-center w-full min-h-96 bg-theme-less-white dark:bg-theme-dark-card rounded-md p-8 m-4",children:s.jsxs("div",{className:"text-center",children:[s.jsx("h1",{className:"text-3xl font-bold text-theme-text-primary mb-4",children:l("user.userNotExist")}),s.jsx("p",{className:"text-lg text-theme-text-secondary",children:l("user.userNotExistDescription")})]})}),!N&&s.jsx(R,{apiQueryKey:e==null?void 0:e.username,linkUrl:`posts/user/${e==null?void 0:e.username}`,enabled:(e==null?void 0:e.username)!==void 0}),s.jsx(T,{children:x!==!1&&s.jsx(F,{showModal:x,setShowModal:g,children:x})})]})}export{X as Profile,X as default};
